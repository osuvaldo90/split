---
phase: 11-security-review
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [.planning/phases/11-security-review/SECURITY-AUDIT.md]
autonomous: true
---

<objective>
Comprehensive security audit of the bill splitting application covering API authorization, input validation, and data exposure.

Purpose: Verify the app is safe for real users before shipping â€” systematic checklist-based review of every endpoint and component.
Output: Security audit report documenting findings organized by security domain.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-security-review/11-CONTEXT.md

# Convex API files to audit
@convex/schema.ts
@convex/sessions.ts
@convex/participants.ts
@convex/items.ts
@convex/claims.ts
@convex/receipts.ts
@convex/actions/parseReceipt.ts

# Frontend files with user input
@src/pages/Home.tsx
@src/pages/Session.tsx
@src/components/ReceiptCapture.tsx
@src/components/InlineItem.tsx
@src/components/TaxTipSettings.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: API Authorization Audit</name>
  <files>.planning/phases/11-security-review/SECURITY-AUDIT.md</files>
  <action>
Systematically review all Convex mutations for authorization gaps.

For EACH mutation endpoint, check:
1. Does it verify the caller has permission? (e.g., is participant in session?)
2. Can anyone modify data they shouldn't own?
3. Are there race conditions or TOCTOU issues?

Endpoints to review:
- sessions.ts: create, updateTip, updateTax, updateTotals, updateGratuity
- participants.ts: join, updateName
- items.ts: add, update, remove, addBulk
- claims.ts: claim, unclaim, unclaimByHost
- receipts.ts: generateUploadUrl, saveReceiptImage

Document findings in SECURITY-AUDIT.md under "## Authorization" section:
- List each endpoint
- Current auth checks (if any)
- Risk level (low/medium/high)
- Recommended fix (if needed)

Key questions:
- Can user A modify user B's claims? (claims.ts unclaim takes any participantId)
- Can non-host modify session settings? (updateTip/updateTax have no host check)
- Can someone join with a forged participantId? (localStorage trust)
  </action>
  <verify>SECURITY-AUDIT.md exists with Authorization section listing all endpoints</verify>
  <done>All mutation endpoints documented with auth analysis</done>
</task>

<task type="auto">
  <name>Task 2: Input Validation Audit</name>
  <files>.planning/phases/11-security-review/SECURITY-AUDIT.md</files>
  <action>
Review all user input points for validation completeness.

For EACH input point, check:
1. Type validation (Convex v.string(), v.number() etc)
2. Length/size limits
3. Character restrictions (XSS in names?)
4. Numeric bounds (negative prices? huge values?)

Input points to review:
- Session code (6-char lookup - timing attacks?)
- Host name / participant name (any length? HTML injection?)
- Item name and price (negative? huge? XSS?)
- Tax/tip values (negative? huge percentages?)
- Receipt image upload (file type? size limits?)

Append findings to SECURITY-AUDIT.md under "## Input Validation" section:
- List each input field
- Current validation
- Risk level
- Recommended improvement (if needed)

Note: Convex validators handle type safety at runtime, but don't enforce business logic constraints.
  </action>
  <verify>SECURITY-AUDIT.md has Input Validation section covering all input points</verify>
  <done>All input points documented with validation analysis</done>
</task>

<task type="auto">
  <name>Task 3: Data Exposure Audit</name>
  <files>.planning/phases/11-security-review/SECURITY-AUDIT.md</files>
  <action>
Review all queries for data exposure issues.

For EACH query endpoint, check:
1. Does it return more data than needed?
2. Can it leak information about other sessions?
3. Are there enumeration risks? (guessing session codes)
4. Receipt images - are they public? Should they be?

Queries to review:
- sessions.ts: getByCode, get
- participants.ts: listBySession, getById, getTotals
- items.ts: listBySession
- claims.ts: listBySession, getByItem, getByParticipant
- receipts.ts: getReceiptUrl

Append findings to SECURITY-AUDIT.md under "## Data Exposure" section:
- List each query
- Data returned
- Access control
- Risk level
- Recommended fix (if needed)

Key questions:
- Can I enumerate session codes? (6-char = 26^6 = 300M combinations)
- Can I access another session's receipt image if I know the storageId?
- Does getTotals expose all participants' financial details to anyone?
  </action>
  <verify>SECURITY-AUDIT.md has Data Exposure section covering all queries</verify>
  <done>All queries documented with data exposure analysis</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] SECURITY-AUDIT.md exists with all three sections
- [ ] Every Convex endpoint (queries + mutations) is listed
- [ ] Each finding has risk level assigned
- [ ] Recommendations are actionable (can be turned into fixes)
</verification>

<success_criteria>
- All tasks completed
- Comprehensive audit document produced
- Every API endpoint reviewed
- Findings organized by security domain
- Risk levels assigned to each finding
</success_criteria>

<output>
After completion, create `.planning/phases/11-security-review/11-01-SUMMARY.md`
</output>
