---
phase: 10.2-join-bill-ui-simplification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/userPreferences.ts
  - src/pages/Home.tsx
autonomous: true
---

<objective>
Unify the home page form into a single name field with optional code, where entering a valid code switches the action from "Start Bill" to "Join Bill".

Purpose: Reduce friction for returning users (name pre-filled) and eliminate separate flows for create vs join.
Output: Unified home page form with smart button adaptation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10.2-join-bill-ui-simplification/10.2-CONTEXT.md

@src/pages/Home.tsx
@src/lib/billHistory.ts
@src/lib/sessionStorage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add user preferences storage for name persistence</name>
  <files>src/lib/userPreferences.ts</files>
  <action>
Create new utility file for user preferences stored in localStorage.

Functions needed:
- `getLastUsedName(): string | null` - Retrieve saved name
- `setLastUsedName(name: string): void` - Save name

Storage key: `split_user_prefs` with JSON object `{ lastUsedName: string }`.

Follow the same error handling pattern as sessionStorage.ts (try/catch with silent failures for localStorage issues).
  </action>
  <verify>File exists and exports both functions with proper types</verify>
  <done>userPreferences.ts created with get/set functions for lastUsedName</done>
</task>

<task type="auto">
  <name>Task 2: Refactor Home.tsx to unified form with smart button</name>
  <files>src/pages/Home.tsx</files>
  <action>
Replace the current two-form approach (create form + expandable join section) with a unified form.

**Layout (vertical stack):**
1. Name input (pre-filled from localStorage via getLastUsedName)
2. Code input (optional, placeholder "ABC123", mono font, uppercase auto-format)
3. Smart button that adapts based on code state

**State consolidation:**
- Single `name` state (replaces both hostName and joinName)
- Keep `code` state for join code
- Remove showJoinSection toggle - join section is always visible as optional code field
- Keep joinSession query for code validation
- Keep storedParticipant query for auto-rejoin logic

**Button logic:**
- No code or code < 6 chars: "Start Bill" (blue-600)
- Code entered, checking: "Checking..." disabled
- Valid code found: "Join Bill" (blue-500 or slightly different shade)
- Invalid code: Show inline error, button stays "Start Bill"

**Name persistence:**
- On mount: pre-fill name from getLastUsedName()
- On successful start/join: call setLastUsedName(name) before navigation

**Error handling:**
- Invalid code: Show error below code input (existing pattern)
- Duplicate name check: Keep existing joinSessionMutation error handling

**Preserve:**
- Auto-rejoin logic (storedParticipant check)
- Bill history section at bottom
- handleKeyDown for Enter key on name input
- All existing mutations and queries

**Remove:**
- showJoinSection state and related toggle logic
- Separate joinName state
- The "Join a Bill" expandable button/section chrome
  </action>
  <verify>npm run build succeeds with no TypeScript errors</verify>
  <done>
- Single name field pre-fills from localStorage
- Code field is always visible but optional
- Button text changes from "Start Bill" to "Join Bill" when valid code entered
- Both flows (create/join) work correctly
- Bill history preserved
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Name pre-fills from localStorage on page load (after prior use)
- [ ] Empty code field + name → "Start Bill" → creates new bill
- [ ] Valid code + name → "Join Bill" → joins existing bill
- [ ] Invalid code shows inline error, button stays "Start Bill"
- [ ] Name saved to localStorage on successful start/join
- [ ] Auto-rejoin still works (entering code for bill you're already in)
- [ ] Bill history tap-to-join preserved
</verification>

<success_criteria>
- All tasks completed
- Build passes with no errors
- Unified form works for both create and join flows
- Name persistence working (pre-fill on return visits)
</success_criteria>

<output>
After completion, create `.planning/phases/10.2-join-bill-ui-simplification/10.2-01-SUMMARY.md`
</output>
