---
phase: 22-handwritten-tip-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/actions/parseReceipt.ts
  - src/pages/Session.tsx
autonomous: true

must_haves:
  truths:
    - "Signed receipt with handwritten tip pre-fills tip field"
    - "Pre-filled amount matches handwritten amount"
    - "User can adjust tip after pre-fill"
    - "Receipts without handwritten tips work normally"
  artifacts:
    - path: "convex/actions/parseReceipt.ts"
      provides: "Handwritten tip detection via Claude Vision"
      contains: "handwritten_tip"
    - path: "src/pages/Session.tsx"
      provides: "Tip pre-fill logic after OCR"
      contains: "handwritten_tip"
  key_links:
    - from: "convex/actions/parseReceipt.ts"
      to: "Claude Vision API"
      via: "Extended prompt and schema"
      pattern: "handwritten_tip.*detected"
    - from: "src/pages/Session.tsx"
      to: "convex/sessions.ts:updateTip"
      via: "mutation call after parseReceipt"
      pattern: "updateTip.*manual.*handwritten"
---

<objective>
Extend receipt OCR to detect handwritten tip amounts and pre-fill the tip field automatically.

Purpose: When users upload a signed receipt with a handwritten tip, save them the manual entry step by pre-filling the detected amount.

Output: Enhanced parseReceipt action that returns handwritten tip data, and Session.tsx logic that pre-fills tip field when confidence is high.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-handwritten-tip-detection/22-CONTEXT.md
@.planning/phases/22-handwritten-tip-detection/22-RESEARCH.md
@convex/actions/parseReceipt.ts
@src/pages/Session.tsx
@convex/sessions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend parseReceipt for handwritten tip detection</name>
  <files>convex/actions/parseReceipt.ts</files>
  <action>
Extend the existing parseReceipt action to detect handwritten tips:

1. **Add to RECEIPT_VALIDATION_PROMPT** (after existing fees instructions):
```
- handwritten_tip: Detect HANDWRITTEN tip amounts on signed receipts
  - Look for pen/pencil marks in the tip or gratuity section
  - Only extract if the writing appears handwritten (not pre-printed)
  - If a dollar amount is written (e.g., "$5", "5.00", "$5.50"):
    - Set detected: true
    - Set amount to the numeric value
    - Set confidence based on handwriting legibility (0.0-1.0)
  - If "CASH", "ON TABLE", or similar text is written:
    - Set detected: true
    - Set amount: null
    - Include raw_text showing what was written
  - If a percentage is written (e.g., "20%"):
    - Set detected: false (we only handle dollar amounts)
  - If amount is crossed out and rewritten:
    - Use the final (uncrossed) value
  - If multiple amounts visible, use the one on the tip line specifically
  - Ignore pre-printed tip suggestions or calculations, even if circled
  - If no handwritten tip visible:
    - Set handwritten_tip: null
```

2. **Add to receiptValidationSchema.properties.data.properties**:
```typescript
handwritten_tip: {
  type: ["object", "null"],
  properties: {
    detected: { type: "boolean" },
    amount: { type: ["number", "null"] },  // null for "CASH"/"ON TABLE"
    confidence: { type: "number" },
    raw_text: { type: "string" }
  },
  required: ["detected", "confidence"],
  additionalProperties: false
}
```

3. **Update required array** in data schema to include "handwritten_tip"

4. **Update TypeScript types**:
- Add HandwrittenTip interface:
```typescript
interface HandwrittenTip {
  detected: boolean;
  amount: number | null;
  confidence: number;
  raw_text?: string;
}
```
- Add `handwritten_tip: HandwrittenTip | null` to ReceiptValidationResponse data type
- Add `handwritten_tip?: HandwrittenTip | null` to ParsedReceipt success type

Do NOT change CONFIDENCE_THRESHOLD (0.7) - handwriting threshold is handled by frontend.
  </action>
  <verify>
TypeScript compilation passes: `npx tsc --noEmit`
Schema changes are valid JSON schema syntax
  </verify>
  <done>
parseReceipt returns handwritten_tip field in successful receipt responses.
ParsedReceipt type includes handwritten_tip for type safety in frontend.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tip pre-fill logic in Session.tsx</name>
  <files>src/pages/Session.tsx</files>
  <action>
Add tip pre-fill logic to handleReceiptUpload after successful OCR:

1. **Add confidence threshold constant** (near top of file, after REJECTION_MESSAGES):
```typescript
// Confidence threshold for handwritten tip pre-fill (higher than receipt validation)
const HANDWRITTEN_TIP_CONFIDENCE_THRESHOLD = 0.8;
```

2. **In handleReceiptUpload**, after the `addBulkFees` call and before `setReceiptState({ step: "idle" })`:
```typescript
// Pre-fill tip from handwritten detection (silent - no toast per user decision)
if (
  "handwritten_tip" in result &&
  result.handwritten_tip?.detected &&
  result.handwritten_tip.amount !== null &&
  result.handwritten_tip.confidence >= HANDWRITTEN_TIP_CONFIDENCE_THRESHOLD
) {
  await updateTip({
    sessionId: session._id,
    tipType: "manual",
    tipValue: Math.round(result.handwritten_tip.amount * 100), // convert dollars to cents
    participantId: currentParticipantId,
  });
}
```

Key implementation notes:
- Only pre-fill when detected is true AND amount is not null AND confidence >= 0.8
- Use tipType "manual" since we're setting a fixed dollar amount
- Convert dollars to cents (multiply by 100 and round)
- Silent behavior - no toast, no indicator (per CONTEXT.md user decision)
- If detection fails or low confidence, tip field remains at default (0)
- updateTip mutation is already imported and available
  </action>
  <verify>
TypeScript compilation passes: `npx tsc --noEmit`
Dev server runs without errors: `npm run dev` (check console)
  </verify>
  <done>
Handwritten tip detection triggers automatic tip pre-fill when confidence is high.
Pre-fill uses manual tip type with dollar amount in cents.
No UI feedback - silent behavior per user requirements.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes
2. Lint check: `npm run lint` passes (if configured)
3. Manual test: Upload receipt image - should not break existing OCR flow
4. Code review: handwritten_tip field present in parseReceipt response type
</verification>

<success_criteria>
- parseReceipt schema includes handwritten_tip object with detected, amount, confidence, raw_text fields
- Session.tsx pre-fills tip when handwritten_tip.detected && amount !== null && confidence >= 0.8
- Existing receipt upload flow works unchanged for receipts without handwritten tips
- TypeScript types are complete - no `any` types used
</success_criteria>

<output>
After completion, create `.planning/phases/22-handwritten-tip-detection/22-01-SUMMARY.md`
</output>
