---
phase: 18-mutation-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [convex/mutations.test.ts]
autonomous: true

# Goal-backward verification
must_haves:
  truths:
    - "Session creation generates valid 6-char alphanumeric codes"
    - "Join creates participant with correct name and isHost=false"
    - "Duplicate names in same session are rejected"
    - "Claiming same item twice returns same claim ID (idempotent)"
    - "Removing an item also removes all its claims"
    - "Empty names are rejected"
    - "Names over 100 chars are rejected"
    - "Negative money values are rejected"
    - "Non-integer money values are rejected"
    - "Tip percent over 100 is rejected"
  artifacts:
    - path: "convex/mutations.test.ts"
      provides: "Core mutation and validation unit tests"
      min_lines: 200
  key_links:
    - from: "mutations.test.ts"
      to: "sessions.create, participants.join, claims.claim, items.remove"
      via: "convex-test mutation calls"
      pattern: "t\\.mutation\\(api\\."
---

<objective>
Comprehensive unit tests for core mutations and input validation.

Purpose: Ensure session creation, participant joining, claim idempotency, item removal cascade, and input validation all work correctly. These tests complement the authorization tests (Phase 16) by testing the actual mutation logic, not just permission checks.

Output: `convex/mutations.test.ts` with tests covering BTEST-16 through BTEST-23
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-authorization-tests/16-01-SUMMARY.md

# Existing test patterns to follow
@convex/sessions.test.ts
@convex/validation.ts

# Mutations to test
@convex/sessions.ts
@convex/participants.ts
@convex/claims.ts
@convex/items.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create session and participant mutation tests (BTEST-16, BTEST-17, BTEST-18)</name>
  <files>convex/mutations.test.ts</files>
  <action>
Create test file with convex-test following established patterns from sessions.test.ts.

**Session creation tests (BTEST-16):**
- Test sessions.create generates 6-character code
- Test code contains only valid characters (ABCDEFGHJKLMNPQRSTUVWXYZ23456789 - no 0/O/1/I/L)
- Test session creation also creates host participant with isHost=true
- Test host participant has same name as hostName

**Join tests (BTEST-17):**
- Test participants.join creates participant with correct sessionId
- Test participant has isHost=false
- Test participant has correct name after validation/trimming

**Duplicate name tests (BTEST-18):**
- Test participants.join rejects exact duplicate name
- Test participants.join rejects case-insensitive duplicate (e.g., "John" vs "john")
- Test error message is user-friendly ("That name is already taken")

Use pattern:
```typescript
import { convexTest } from "convex-test";
import { describe, it, expect } from "vitest";
import schema from "./schema";
import { api } from "./_generated/api";

describe("session creation", () => {
  it("generates valid 6-char code (BTEST-16)", async () => {
    const t = convexTest(schema);
    const result = await t.mutation(api.sessions.create, { hostName: "Host" });
    expect(result.code).toHaveLength(6);
    expect(result.code).toMatch(/^[ABCDEFGHJKLMNPQRSTUVWXYZ23456789]+$/);
  });
});
```
  </action>
  <verify>npm test -- --run convex/mutations.test.ts passes all session/participant tests</verify>
  <done>Tests for BTEST-16, BTEST-17, BTEST-18 pass</done>
</task>

<task type="auto">
  <name>Task 2: Create claim and item cascade tests (BTEST-19, BTEST-20)</name>
  <files>convex/mutations.test.ts</files>
  <action>
Add tests for claim idempotency and item removal cascade.

**Claim idempotency tests (BTEST-19):**
- Test claims.claim returns same claimId when called twice for same item/participant
- Test database still has only one claim record after double-claim
- Test claim is properly created on first call

**Item removal cascade tests (BTEST-20):**
- Test items.remove deletes the item
- Test items.remove also deletes all associated claims
- Setup: Create item, have 2 participants claim it, then host removes item
- Verify: Item gone, both claims gone

Use pattern:
```typescript
describe("claim idempotency", () => {
  it("returns same claim ID when claiming twice (BTEST-19)", async () => {
    const t = convexTest(schema);
    // Setup: session + item + participant
    // Action: claim twice
    // Verify: same ID returned, only one claim in DB
  });
});
```
  </action>
  <verify>npm test -- --run convex/mutations.test.ts passes all claim/cascade tests</verify>
  <done>Tests for BTEST-19, BTEST-20 pass</done>
</task>

<task type="auto">
  <name>Task 3: Create input validation tests (BTEST-21, BTEST-22, BTEST-23)</name>
  <files>convex/mutations.test.ts</files>
  <action>
Add tests for validation.ts functions through actual mutation calls.

**Name validation tests (BTEST-21):**
- Test empty name is rejected (sessions.create with hostName: "")
- Test whitespace-only name is rejected (hostName: "   ")
- Test name over 100 chars is rejected (MAX_NAME_LENGTH = 100)
- Test name is trimmed (hostName: "  John  " -> "John")
- Test participants.join with same validation rules

**Money validation tests (BTEST-22):**
- Test negative price is rejected (items.add with price: -100)
- Test non-integer cents is rejected (items.add with price: 10.5)
- Test Infinity is rejected (items.add with price: Infinity)
- Test NaN is rejected (items.add with price: NaN)
- Test price over MAX_MONEY_CENTS ($100,000 = 10,000,000 cents) is rejected
- Test sessions.updateTax with same validation rules

**Tip percent validation tests (BTEST-23):**
- Test negative percent is rejected (sessions.updateTip with tipValue: -5)
- Test percent over 100 is rejected (sessions.updateTip with tipValue: 150)
- Test Infinity/NaN rejected
- Test valid percent works (0, 15, 20, 100)

All validation tests should verify the error message is appropriate.

Use pattern:
```typescript
describe("input validation", () => {
  describe("name validation (BTEST-21)", () => {
    it("rejects empty name", async () => {
      const t = convexTest(schema);
      await expect(t.mutation(api.sessions.create, { hostName: "" }))
        .rejects.toThrow("cannot be empty");
    });
  });
});
```
  </action>
  <verify>npm test -- --run convex/mutations.test.ts passes all validation tests</verify>
  <done>Tests for BTEST-21, BTEST-22, BTEST-23 pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test` passes all tests (including new mutations.test.ts)
- [ ] All 8 BTEST requirements (16-23) have corresponding tests
- [ ] Test names explicitly reference BTEST requirement IDs
- [ ] No TypeScript errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Tests cover session creation, join, duplicate names, claim idempotency, cascade deletion, and all input validation types
- Combined test count increased by ~30+ tests
</success_criteria>

<output>
After completion, create `.planning/phases/18-mutation-tests/18-01-SUMMARY.md`
</output>
