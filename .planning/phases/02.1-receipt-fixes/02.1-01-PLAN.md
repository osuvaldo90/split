---
phase: 02.1-receipt-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [convex/items.ts, src/pages/Session.tsx, src/components/ItemEditor.tsx, src/components/ReceiptReview.tsx]
autonomous: true
---

<objective>
Fix receipt upload replace behavior and money input formatting.

Purpose: Improve UX by ensuring new receipts replace existing items and money displays consistently with 2 decimal places.
Output: Working replace functionality and consistent $X.XX formatting throughout the app.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@convex/items.ts
@src/pages/Session.tsx
@src/components/ItemEditor.tsx
@src/components/ReceiptReview.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement receipt replace behavior</name>
  <files>convex/items.ts, src/pages/Session.tsx</files>
  <action>
1. In convex/items.ts, modify the `addBulk` mutation to:
   - First delete all existing items for the session (query by_session, delete each)
   - Also delete associated claims for each deleted item
   - Then insert the new items as before

2. In src/pages/Session.tsx:
   - The "Replace Receipt" button at line 125-129 currently does nothing useful
   - Remove it since the ReceiptCapture component is already shown and will trigger replacement
   - OR keep it but make it more prominent (e.g., make it actually trigger the file input)
   - Simpler: just remove the redundant button since ReceiptCapture already shows camera/upload buttons

The flow should be: user uploads new receipt → existing items cleared → new items added.
  </action>
  <verify>
1. Create a session, upload a receipt, confirm items
2. Upload a different receipt
3. Verify only the new receipt's items appear (old items replaced, not appended)
  </verify>
  <done>New receipt uploads completely replace existing items, no duplicates</done>
</task>

<task type="auto">
  <name>Task 2: Format money inputs consistently</name>
  <files>src/components/ItemEditor.tsx, src/components/ReceiptReview.tsx</files>
  <action>
Fix price display to always show 2 decimal places:

1. In ItemEditor.tsx:
   - Change the price input `value={item.price}` to `value={item.price.toFixed(2)}`
   - Keep the onChange handler as-is (parseFloat handles user input)

2. In ReceiptReview.tsx:
   - Same fix for subtotal and tax inputs
   - For inputs with nullable values, format only when value exists: `value={subtotal?.toFixed(2) ?? ""}`

This ensures $4.80 displays as "4.80" not "4.8" in all money input fields.

Note: toFixed(2) on a number input value works because HTML inputs accept string values and will display them correctly. The onChange handlers already parse back to numbers.
  </action>
  <verify>
1. Open the receipt review screen
2. Check that all prices show 2 decimal places (e.g., "4.80" not "4.8")
3. Edit a price, verify it still shows 2 decimals after blur
4. Check subtotal and tax fields also show 2 decimals
  </verify>
  <done>All money values display with exactly 2 decimal places ($X.XX format)</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Upload receipt with items, then upload different receipt → only new items shown
- [ ] All price fields show 2 decimal places
- [ ] Editing prices works correctly
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Receipt replacement works end-to-end
- Money formatting consistent throughout
  </success_criteria>

<output>
After completion, create `.planning/phases/02.1-receipt-fixes/02.1-01-SUMMARY.md`
</output>
