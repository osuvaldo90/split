---
phase: 02-receipt-processing
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - src/components/ReceiptReview.tsx
  - src/components/ItemEditor.tsx
  - src/pages/Session.tsx
autonomous: false
---

<objective>
Build the error correction UI and integrate the complete receipt processing flow.

Purpose: Allow users to review OCR-extracted items, edit mistakes, add missing items, adjust totals, and confirm before saving. This ensures data quality despite OCR imperfections.

Output: Complete receipt flow integrated on Session page: capture → OCR → review/edit → confirm → save items.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-receipt-processing/02-RESEARCH.md

# Prior plan summaries (need file storage and OCR)
@.planning/phases/02-receipt-processing/02-01-SUMMARY.md
@.planning/phases/02-receipt-processing/02-02-SUMMARY.md

# Existing source files
@convex/schema.ts
@convex/items.ts
@convex/receipts.ts
@convex/actions/parseReceipt.ts
@src/pages/Session.tsx
@src/components/ReceiptCapture.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ItemEditor component for inline item editing</name>
  <files>src/components/ItemEditor.tsx</files>
  <action>
Create an inline editor for a single receipt item:

**Props:**
```typescript
interface ItemEditorProps {
  item: { name: string; price: number; quantity: number };
  onChange: (updated: { name: string; price: number; quantity: number }) => void;
  onDelete: () => void;
}
```

**UI elements (single row, horizontal layout):**
- Name input: flex-1, text input
- Price input: w-24, number input with step="0.01"
- Quantity input: w-16, number input (optional, default hidden if quantity is 1)
- Delete button: red X icon/button

**Styling:**
- Mobile-first: inputs stack on very small screens, row on larger
- Clear tap targets (min 44px height for touch)
- Visual feedback on focus

**Behavior:**
- Call `onChange` on any input change (controlled inputs)
- Call `onDelete` when delete button clicked
- Price displays in dollars (e.g., 12.99), will be converted to cents on save
  </action>
  <verify>Component renders, inputs work, TypeScript compiles</verify>
  <done>ItemEditor component exports, handles editing single item</done>
</task>

<task type="auto">
  <name>Task 2: Create ReceiptReview component for reviewing extracted items</name>
  <files>src/components/ReceiptReview.tsx</files>
  <action>
Create the receipt review screen:

**Props:**
```typescript
interface ReceiptReviewProps {
  initialItems: Array<{ name: string; price: number; quantity: number }>;
  initialSubtotal: number | null;
  initialTax: number | null;
  sessionId: Id<"sessions">;
  onConfirm: () => void;
  onCancel: () => void;
}
```

**UI structure:**
1. Header: "Review Items" with item count
2. Item list: Map over items, render ItemEditor for each
3. "Add Item" button: Adds blank item `{ name: "", price: 0, quantity: 1 }`
4. Totals section:
   - Subtotal input (number, optional - can be null)
   - Tax input (number, optional - can be null)
   - Calculated total display (sum of item prices, or subtotal + tax if provided)
5. Action buttons:
   - "Cancel" button: calls `onCancel`
   - "Confirm Items" button: saves items and calls `onConfirm`

**State management:**
- Local state for `editedItems` array
- Local state for `subtotal` and `tax`
- Handle add/edit/delete operations on items array

**On Confirm:**
1. Filter out items with empty names
2. Convert prices from dollars to cents: `Math.round(price * 100)`
3. Call `api.items.addBulk` mutation with sessionId and items
4. Call `api.sessions.updateTotals` mutation if subtotal/tax provided
5. Call `onConfirm()` callback

**Styling:**
- Mobile-first layout
- Clear visual hierarchy
- Prominent "Confirm" button (green/primary)
- Secondary "Cancel" button
  </action>
  <verify>Component renders item list, editing works, confirm saves to database</verify>
  <done>ReceiptReview component exports, manages item list state, saves on confirm</done>
</task>

<task type="auto">
  <name>Task 3: Integrate receipt flow on Session page</name>
  <files>src/pages/Session.tsx</files>
  <action>
Add the complete receipt processing flow to the Session page:

**New state:**
```typescript
type ReceiptState =
  | { step: "idle" }
  | { step: "uploading" }
  | { step: "processing", storageId: Id<"_storage"> }
  | { step: "reviewing", data: ParsedReceipt, storageId: Id<"_storage"> }
  | { step: "error", message: string };
```

**Flow implementation:**

1. **Idle state:** Show ReceiptCapture component
   - On upload complete: transition to "processing"

2. **Processing state:** Show "Analyzing receipt..." loading indicator
   - Call `api.actions.parseReceipt` action with storageId
   - On success: transition to "reviewing" with parsed data
   - On error: transition to "error" state

3. **Reviewing state:** Show ReceiptReview component
   - Pass parsed items, subtotal, tax
   - On confirm: transition back to "idle", items are now in database
   - On cancel: transition back to "idle" (discard extracted data)

4. **Error state:** Show error message with "Try Again" button
   - On retry: transition back to "idle"

**UI placement:**
- Add receipt section to Session page (only for host? or anyone?)
- Show receipt image thumbnail if `session.receiptImageId` exists
- Show item list from database below receipt section

**Conditional rendering:**
- Only show capture UI if no receipt uploaded yet, OR show "Replace Receipt" option
- Show items list if items exist in database

Do NOT worry about real-time sync for now - that's Phase 4.
  </action>
  <verify>Flow works: capture → processing → review → confirmed items appear</verify>
  <done>Session page has complete receipt flow, items save to database</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete receipt processing flow: camera capture → OCR extraction → item review/editing → confirmation</what-built>
  <how-to-verify>
    1. Run: `npm run dev` (and ensure `npx convex dev` is running)
    2. Visit: http://localhost:5173
    3. Create a new session (or use existing)
    4. Test camera capture:
       - Click "Take Photo" - should open device camera (on mobile) or file picker (desktop)
       - Select/take a photo of a receipt
       - Should show "Uploading..." then "Analyzing receipt..."
    5. Review OCR results:
       - Items should appear in editable list
       - Try editing an item name or price
       - Try deleting an item
       - Try adding a new item
    6. Confirm items:
       - Click "Confirm Items"
       - Items should now appear in the session's item list
    7. Verify mobile experience:
       - Test on actual phone if possible, or use Chrome DevTools device mode
       - Buttons should be easy to tap
       - Layout should not overflow horizontally
  </how-to-verify>
  <resume-signal>Type "approved" if the flow works correctly, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] Receipt capture → OCR → review flow works end-to-end
- [ ] Items save correctly to database
- [ ] Mobile layout is usable
- [ ] Human verification checkpoint passed
</verification>

<success_criteria>
- All tasks completed
- Complete receipt flow works end-to-end
- Items can be edited before saving
- User approved visual/functional verification
</success_criteria>

<output>
After completion, create `.planning/phases/02-receipt-processing/02-03-SUMMARY.md`
</output>
