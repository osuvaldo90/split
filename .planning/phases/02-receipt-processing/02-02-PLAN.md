---
phase: 02-receipt-processing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/actions/parseReceipt.ts
  - package.json
  - .env.local
autonomous: true
---

<objective>
Integrate Claude Vision API for receipt OCR extraction.

Purpose: Extract line items, prices, tax, and totals from receipt images using Claude's vision capabilities. This transforms a photo into structured data that can be reviewed and edited.

Output: Convex action that takes a storageId and returns parsed receipt data as JSON.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-receipt-processing/02-RESEARCH.md

# Existing source files
@convex/schema.ts
@convex/items.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Anthropic SDK and configure environment</name>
  <files>package.json, .env.local</files>
  <action>
1. Install the Anthropic SDK:
   ```bash
   npm install @anthropic-ai/sdk
   ```

2. Add ANTHROPIC_API_KEY to `.env.local`:
   - Check if the key already exists in `.env.local`
   - If not, add a placeholder: `ANTHROPIC_API_KEY=sk-ant-...`
   - The user will need to provide their actual API key

Note: Convex actions can access environment variables via `process.env`. The key will be read at runtime.
  </action>
  <verify>npm ls @anthropic-ai/sdk shows package installed</verify>
  <done>Anthropic SDK installed, ANTHROPIC_API_KEY placeholder in .env.local</done>
</task>

<task type="auto">
  <name>Task 2: Create Convex action for Claude Vision OCR</name>
  <files>convex/actions/parseReceipt.ts</files>
  <action>
Create a Convex action that:

1. Takes a `storageId` (Id<"_storage">) as argument
2. Retrieves the image blob from Convex storage
3. Converts to base64 for the Claude API
4. Calls Claude Vision API with a structured prompt
5. Parses and returns the JSON response

**Prompt template:**
```
Extract all line items from this receipt image.
Return ONLY valid JSON in this exact format:
{
  "merchant": "store name or null if unclear",
  "items": [
    { "name": "item description", "price": 12.99, "quantity": 1 }
  ],
  "subtotal": 45.97,
  "tax": 3.68,
  "total": 49.65
}
Rules:
- Prices must be numbers (not strings), in dollars (not cents)
- Include ALL items, even if quantity is 1
- If a field is unclear or missing, use null
- Do NOT include any explanation, ONLY the JSON object
```

**Implementation details:**
- Model: `claude-sonnet-4-5-20250514` (or latest sonnet)
- Max tokens: 2048 (receipts are short)
- Handle both success and error cases:
  - If JSON parses successfully, return the data
  - If JSON parsing fails, return `{ error: "parse_failed", raw: responseText }`
  - If API call fails, throw error (Convex will handle)

**Response type:**
```typescript
type ParsedReceipt = {
  merchant: string | null;
  items: Array<{ name: string; price: number; quantity: number }>;
  subtotal: number | null;
  tax: number | null;
  total: number | null;
} | {
  error: string;
  raw: string;
}
```

Do NOT add retry logic yet - that's an optimization for later.
  </action>
  <verify>Action compiles without errors in Convex dashboard</verify>
  <done>parseReceipt action exports, accepts storageId, returns parsed receipt JSON or error</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] `npx convex dev` runs without errors
- [ ] Action appears in Convex dashboard under Actions
- [ ] TypeScript types are correct
</verification>

<success_criteria>
- All tasks completed
- Anthropic SDK installed
- parseReceipt action compiles and is accessible
- Action handles both success and error cases gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/02-receipt-processing/02-02-SUMMARY.md`
</output>
