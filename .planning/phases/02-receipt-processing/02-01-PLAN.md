---
phase: 02-receipt-processing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/receipts.ts
  - src/components/ReceiptCapture.tsx
  - package.json
autonomous: true
---

<objective>
Create camera capture and file upload infrastructure for receipt images.

Purpose: Enable users to photograph or upload receipts, storing them in Convex file storage for later OCR processing. This is the entry point for the receipt processing pipeline.

Output: Working file upload mutations and a mobile-friendly capture component that triggers device camera.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-receipt-processing/02-RESEARCH.md

# Prior phase context
@.planning/phases/01-foundation/01-03-SUMMARY.md

# Existing source files
@convex/schema.ts
@convex/sessions.ts
@src/pages/Session.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Convex file storage mutations for receipts</name>
  <files>convex/receipts.ts</files>
  <action>
Create mutations for the 3-step Convex file upload flow:

1. `generateUploadUrl` - Generate a short-lived upload URL (expires in 1 hour)
2. `saveReceiptImage` - Save the storageId to the session after upload
3. `getReceiptUrl` - Query to get the serving URL for a stored receipt

Implementation details:
- `generateUploadUrl`: No args, returns `ctx.storage.generateUploadUrl()`
- `saveReceiptImage`: Takes sessionId and storageId, patches session with `receiptImageId`
- `getReceiptUrl`: Takes storageId, returns `ctx.storage.getUrl(storageId)`

Note: The schema already has `receiptImageId: v.optional(v.id("_storage"))` on sessions table from Phase 1.
  </action>
  <verify>npx convex dev shows no errors, mutations appear in api object</verify>
  <done>All three mutations compile and are accessible via api.receipts.*</done>
</task>

<task type="auto">
  <name>Task 2: Build ReceiptCapture component with camera and upload buttons</name>
  <files>src/components/ReceiptCapture.tsx</files>
  <action>
Create a mobile-first receipt capture component:

1. Two capture methods:
   - "Take Photo" button: `<input type="file" accept="image/*" capture="environment">` (opens rear camera on mobile)
   - "Upload Image" button: `<input type="file" accept="image/*">` (opens file picker)

2. Upload flow (on file selection):
   - Show loading state ("Uploading...")
   - Call `generateUploadUrl` mutation
   - POST file to the URL with correct Content-Type header
   - Parse response for `storageId`
   - Call `saveReceiptImage` mutation with sessionId and storageId
   - Call `onUpload(storageId)` callback prop

3. Props interface:
   ```typescript
   interface ReceiptCaptureProps {
     sessionId: Id<"sessions">;
     onUpload: (storageId: Id<"_storage">) => void;
     disabled?: boolean;
   }
   ```

4. Styling: Use Tailwind classes for mobile-first design:
   - Full-width buttons on mobile
   - Clear visual feedback during upload
   - Disabled state when `disabled` prop is true

5. Error handling:
   - Catch upload failures
   - Show error message (use console.error for now, UI error handling in Phase 8)
   - Reset file input after upload (success or failure)

Do NOT add image compression yet - that's an optimization for later.
  </action>
  <verify>Component renders without TypeScript errors, file input triggers correctly</verify>
  <done>ReceiptCapture component exports, accepts props, handles file upload to Convex storage</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx convex dev` runs without errors
- [ ] `npm run build` succeeds
- [ ] ReceiptCapture component can be imported
- [ ] Mutations are accessible via `api.receipts.*`
</verification>

<success_criteria>
- All tasks completed
- File upload mutations working in Convex
- ReceiptCapture component handles camera and file upload
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-receipt-processing/02-01-SUMMARY.md`
</output>
