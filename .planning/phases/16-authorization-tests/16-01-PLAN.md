---
phase: 16-authorization-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/sessions.test.ts
  - convex/items.test.ts
  - convex/claims.test.ts
autonomous: true

# Goal-backward verification
must_haves:
  truths:
    - "Tests verify non-participants cannot add items (BTEST-01)"
    - "Tests verify non-participants cannot claim items (BTEST-02)"
    - "Tests verify non-hosts cannot update tip settings (BTEST-03)"
    - "Tests verify non-hosts cannot update tax settings (BTEST-04)"
    - "Tests verify non-hosts cannot remove items (BTEST-05)"
    - "Tests verify non-hosts cannot use addBulk (BTEST-06)"
    - "Tests verify hosts can perform host-only actions (BTEST-07)"
    - "Tests verify participants can claim/unclaim own items (BTEST-08)"
    - "Tests verify cross-session access is denied (BTEST-09)"
  artifacts:
    - path: "convex/sessions.test.ts"
      provides: "Host-only mutation tests (tip, tax, gratuity)"
      min_lines: 80
    - path: "convex/items.test.ts"
      provides: "Item mutation authorization tests (add, remove, addBulk)"
      min_lines: 100
    - path: "convex/claims.test.ts"
      provides: "Claim mutation authorization tests (claim, unclaim, cross-session)"
      min_lines: 80
  key_links:
    - from: "convex/sessions.test.ts"
      to: "convex/sessions.ts"
      via: "imports updateTip, updateTax, updateGratuity mutations"
      pattern: "import.*from.*sessions"
    - from: "convex/items.test.ts"
      to: "convex/items.ts"
      via: "imports add, remove, addBulk mutations"
      pattern: "import.*from.*items"
    - from: "convex/claims.test.ts"
      to: "convex/claims.ts"
      via: "imports claim, unclaim mutations"
      pattern: "import.*from.*claims"
---

<objective>
Create comprehensive authorization tests for all mutation functions that have access control.

Purpose: Verify the authorization layer is airtight â€” every access boundary is tested so we have confidence to ship without access control regressions.

Output: 3 test files covering all 9 BTEST requirements for authorization.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-test-infrastructure/15-01-SUMMARY.md
@.planning/phases/16-authorization-tests/16-CONTEXT.md

# Source files being tested
@convex/sessions.ts
@convex/items.ts
@convex/claims.ts
@convex/participants.ts

# Test infrastructure
@convex/test.setup.ts
@vitest.config.ts
@tests/example.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create session authorization tests</name>
  <files>convex/sessions.test.ts</files>
  <action>
Create unit tests for host-only session mutations. Use convex-test for mocked database context.

**Test structure:**
```typescript
import { convexTest } from "convex-test";
import { describe, it, expect } from "vitest";
import schema from "./schema";
import { api } from "./_generated/api";
```

**Setup helper (create in each test or as beforeEach):**
- Create a session with host
- Create a non-host participant
- Create a participant from a DIFFERENT session (for cross-session tests)

**Tests for updateTip (BTEST-03, BTEST-07):**
- `it("allows host to update tip")` - host can set tipType and tipValue
- `it("rejects non-host updating tip")` - throws "Only the host can modify bill settings"
- `it("rejects cross-session tip update")` - throws "Participant not in this session"

**Tests for updateTax (BTEST-04, BTEST-07):**
- `it("allows host to update tax")` - host can set tax value
- `it("rejects non-host updating tax")` - throws "Only the host can modify bill settings"
- `it("rejects cross-session tax update")` - throws "Participant not in this session"

**Tests for updateGratuity (BTEST-07):**
- `it("allows host to update gratuity")` - host can set gratuity value
- `it("rejects non-host updating gratuity")` - throws "Only the host can modify bill settings"

**Pattern for testing mutations with convex-test:**
```typescript
const t = convexTest(schema);
// Insert test data directly
const sessionId = await t.run(async (ctx) => {
  return await ctx.db.insert("sessions", { code: "ABC123", hostName: "Host", createdAt: Date.now() });
});
// Then test mutation
await expect(
  t.mutation(api.sessions.updateTip, { sessionId, participantId: nonHostId, tipType: "percent_subtotal", tipValue: 18 })
).rejects.toThrow("Only the host can modify bill settings");
```
  </action>
  <verify>npm test -- convex/sessions.test.ts passes with all tests green</verify>
  <done>8-10 tests covering BTEST-03, BTEST-04, BTEST-07 (partial), BTEST-09 (partial)</done>
</task>

<task type="auto">
  <name>Task 2: Create item authorization tests</name>
  <files>convex/items.test.ts</files>
  <action>
Create unit tests for item mutations with authorization checks.

**Tests for items.add (BTEST-01):**
- `it("allows participant to add item")` - valid participant can add
- `it("rejects non-participant adding item")` - invalid participantId throws "Not authorized to add items"
- `it("rejects cross-session item add")` - participant from different session throws error

**Tests for items.remove (BTEST-05, BTEST-07):**
- `it("allows host to remove item")` - host can delete item and cascades claims
- `it("rejects non-host removing item")` - throws "Only the host can remove items"
- `it("rejects cross-session item removal")` - host from different session cannot remove

**Tests for items.addBulk (BTEST-06, BTEST-07):**
- `it("allows host to bulk add items")` - host can replace all items
- `it("rejects non-host bulk adding")` - throws "Only the host can replace all items"
- `it("rejects cross-session bulk add")` - host from different session cannot bulk add

**Verify claim cascade on remove:**
When testing items.remove as host, first create claims on the item, then verify they are deleted when item is removed.
  </action>
  <verify>npm test -- convex/items.test.ts passes with all tests green</verify>
  <done>9-11 tests covering BTEST-01, BTEST-05, BTEST-06, BTEST-07 (partial), BTEST-09 (partial)</done>
</task>

<task type="auto">
  <name>Task 3: Create claim authorization tests</name>
  <files>convex/claims.test.ts</files>
  <action>
Create unit tests for claim mutations with authorization checks.

**Tests for claims.claim (BTEST-02, BTEST-08):**
- `it("allows participant to claim item")` - valid participant can claim
- `it("rejects non-participant claiming")` - invalid participantId throws "Not authorized to claim items"
- `it("rejects cross-session claim")` - participant from different session cannot claim
- `it("handles idempotent claim")` - claiming same item twice returns same claimId

**Tests for claims.unclaim (BTEST-08):**
- `it("allows participant to unclaim own item")` - self-unclaim works
- `it("allows host to unclaim any participant")` - host can unclaim others
- `it("rejects participant unclaiming others")` - non-host cannot unclaim others' claims

**Tests for claims.unclaimByHost (BTEST-07):**
- `it("allows host to unclaim for others")` - host can remove any claim
- `it("rejects non-host using unclaimByHost")` - throws "Only host can unclaim for others"
- `it("rejects cross-session host unclaim")` - host from different session cannot unclaim

**Cross-session coverage (BTEST-09):**
Ensure at least 2-3 tests explicitly verify cross-session access denial across different mutation types.
  </action>
  <verify>npm test -- convex/claims.test.ts passes with all tests green</verify>
  <done>10-12 tests covering BTEST-02, BTEST-07 (partial), BTEST-08, BTEST-09 (partial)</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test` passes all authorization tests
- [ ] Each BTEST requirement has at least one test covering it
- [ ] BTEST-01 through BTEST-09 all have test coverage
- [ ] No TypeScript errors in test files
- [ ] Cross-session access denied tests exist for sessions, items, and claims
</verification>

<success_criteria>

- All 3 test files created and passing
- ~25-30 total test cases covering all 9 requirements
- Authorization boundaries tested: participant access, host-only access, self-only access, cross-session access
- All tests use convex-test with mocked database (no real Convex deployment needed)
</success_criteria>

<output>
After completion, create `.planning/phases/16-authorization-tests/16-01-SUMMARY.md`
</output>
