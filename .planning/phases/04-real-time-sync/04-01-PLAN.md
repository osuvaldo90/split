---
phase: 04-real-time-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/lib/sessionStorage.ts, src/pages/Join.tsx, convex/participants.ts]
autonomous: true
---

<objective>
Implement participant session persistence so users don't have to re-enter their name when refreshing or revisiting a session.

Purpose: Core UX requirement from phase context - "Refreshing the browser shouldn't make you re-enter your name. You're still you."
Output: localStorage-based session storage with automatic participant restoration on page load.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-real-time-sync/04-CONTEXT.md

@src/pages/Join.tsx
@convex/participants.ts
@convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create session storage utility</name>
  <files>src/lib/sessionStorage.ts</files>
  <action>
Create a utility module for localStorage-based session persistence:

```typescript
interface StoredSession {
  sessionCode: string;
  participantId: string;
}

// Key format: split_session_{code}
export function getStoredParticipant(sessionCode: string): string | null
export function storeParticipant(sessionCode: string, participantId: string): void
export function clearParticipant(sessionCode: string): void
```

Use try-catch around localStorage operations (can fail in private browsing). Return null on any error.
  </action>
  <verify>File exists with proper TypeScript types, no compile errors</verify>
  <done>Session storage utility with get/store/clear functions exported</done>
</task>

<task type="auto">
  <name>Task 2: Add participant lookup query</name>
  <files>convex/participants.ts</files>
  <action>
Add a query to fetch a participant by ID (needed to verify stored participant still exists):

```typescript
export const getById = query({
  args: { participantId: v.id("participants") },
  handler: async (ctx, args) => {
    return await ctx.db.get(args.participantId);
  },
});
```

Simple ID lookup - returns participant or null if deleted.
  </action>
  <verify>npx convex dev runs without error, query appears in api</verify>
  <done>getById query added to participants.ts</done>
</task>

<task type="auto">
  <name>Task 3: Integrate session persistence in Join flow</name>
  <files>src/pages/Join.tsx</files>
  <action>
Modify Join.tsx to:

1. When a valid session is found (code entered), check localStorage for existing participantId
2. If found, query getById to verify participant exists in that session
3. If participant still valid, auto-redirect to session (skip name entry)
4. If not valid (deleted/wrong session), clear localStorage and show normal name entry
5. On successful join, store the new participantId in localStorage

Add useEffect that runs when `session` becomes available to check for stored participant.
Use the storage utility from src/lib/sessionStorage.ts.

Handle loading state: show "Checking..." while verifying stored participant.
  </action>
  <verify>
1. Join a session with name, note you're redirected to session page
2. Close tab, reopen /join, enter same code → should auto-redirect without name entry
3. Clear localStorage, try again → should show name entry form
  </verify>
  <done>Returning users automatically rejoin without re-entering name</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Join flow works normally for new users
- [ ] Returning users (same browser) auto-rejoin their session
- [ ] Clearing localStorage resets to normal flow
</verification>

<success_criteria>

- All tasks completed
- Session persistence works across browser refresh
- No TypeScript errors
- localStorage failures handled gracefully (don't break the app)
</success_criteria>

<output>
After completion, create `.planning/phases/04-real-time-sync/04-01-SUMMARY.md`
</output>
