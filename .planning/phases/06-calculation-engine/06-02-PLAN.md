---
phase: 06-calculation-engine
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified: [src/components/TaxTipSettings.tsx, convex/sessions.ts]
autonomous: true
---

<objective>
Create Tax & Tip settings UI that allows host to configure tip percentage/amount and override tax if needed.

Purpose: Enable host to set tip preferences that auto-calculate everyone's share.
Output: TaxTipSettings component with host-only editing and real-time preview.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-calculation-engine/06-CONTEXT.md
@.planning/phases/06-calculation-engine/06-01-SUMMARY.md

@convex/schema.ts
@convex/sessions.ts
@src/pages/Session.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TaxTipSettings component</name>
  <files>src/components/TaxTipSettings.tsx</files>
  <action>
Create a new component for configuring tax and tip settings:

Props:
- session: Session object (with tax, tipType, tipValue)
- isHost: boolean
- groupSubtotal: number (in cents, for preview calculations)

UI Structure:
1. **Tax Section**
   - Label: "Tax" with current value displayed
   - If isHost: editable input (pre-filled from OCR or 0)
   - If not host: display only with "(set by host)" note
   - Input: dollar amount, converts to cents on save

2. **Tip Section**
   - Label: "Tip"
   - If isHost:
     - Free text input for percentage (e.g., "20")
     - Toggle: "on subtotal" vs "on subtotal + tax"
     - OR: "Manual amount" option with dollar input
   - If not host: display current tip settings read-only

3. **Preview**
   - Show calculated tip amount based on current settings and groupSubtotal
   - Update in real-time as user types

Styling:
- Use existing Tailwind patterns from Session.tsx
- Disabled/muted styling for non-host view
- Clear visual distinction between editable and read-only

Use useMutation for sessions.updateTip and a new sessions.updateTax mutation.
  </action>
  <verify>Component renders without errors: npm run build</verify>
  <done>TaxTipSettings component created with host/non-host views</done>
</task>

<task type="auto">
  <name>Task 2: Add updateTax mutation and integrate component</name>
  <files>convex/sessions.ts, src/components/TaxTipSettings.tsx</files>
  <action>
1. Add updateTax mutation to convex/sessions.ts:
```typescript
export const updateTax = mutation({
  args: {
    sessionId: v.id("sessions"),
    tax: v.number(), // in cents
  },
  handler: async (ctx, args) => {
    await ctx.db.patch(args.sessionId, { tax: args.tax });
  },
});
```

2. Wire up TaxTipSettings to call mutations:
   - updateTax when tax input changes (debounce or on blur)
   - updateTip when tip settings change
   - Use optimistic updates for smooth UX

3. Add real-time calculation preview:
   - Import and use calculation functions from convex/calculations.ts
   - Show "Tip total: $X.XX" based on current groupSubtotal and tip settings
  </action>
  <verify>
```bash
npx tsc --noEmit
npm run build
```
  </verify>
  <done>Tax/Tip settings save to database and show live preview</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] TaxTipSettings renders correctly for host view
- [ ] TaxTipSettings renders read-only for non-host
- [ ] updateTax and updateTip mutations work
- [ ] Tip preview updates as settings change
</verification>

<success_criteria>

- Host can edit tax and tip settings
- Non-host sees settings in read-only mode
- Changes persist to database
- Preview shows calculated tip amount
</success_criteria>

<output>
After completion, create `.planning/phases/06-calculation-engine/06-02-SUMMARY.md`
</output>
