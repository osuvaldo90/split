---
phase: 06-calculation-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [convex/calculations.ts, convex/participants.ts]
autonomous: true
---

<objective>
Implement calculation logic for proportional tax distribution, tip calculation, and per-participant totals.

Purpose: Foundation for all calculation-related features â€” tax/tip settings and summary screens depend on this.
Output: Calculation utility functions and participantTotals query with real-time updates.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-calculation-engine/06-CONTEXT.md

@convex/schema.ts
@convex/sessions.ts
@convex/claims.ts
@convex/items.ts
@convex/participants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create calculation utility functions</name>
  <files>convex/calculations.ts</files>
  <action>
Create a new convex/calculations.ts file with pure calculation functions:

1. `calculateItemShare(itemPrice: number, claimCount: number): number`
   - Returns price per claimant (itemPrice / claimCount)
   - Use Math.floor for division, distribute remainder cents to first claimants
   - Example: $10 split 3 ways = [334, 333, 333] cents

2. `calculateSubtotalShare(participantItemTotal: number, groupSubtotal: number): number`
   - Returns participant's proportion of the group subtotal (0 to 1)
   - Handle edge case: if groupSubtotal is 0, return 0

3. `calculateTaxShare(participantSubtotal: number, groupSubtotal: number, totalTax: number): number`
   - Proportional tax: (participantSubtotal / groupSubtotal) * totalTax
   - Round to nearest cent with remainder distribution

4. `calculateTipShare(participantSubtotal: number, participantTax: number, groupSubtotal: number, groupTax: number, tipType: 'percent_subtotal' | 'percent_total' | 'manual', tipValue: number): number`
   - percent_subtotal: tipValue% of participant's subtotal
   - percent_total: tipValue% of (participant's subtotal + tax)
   - manual: proportional share of manual tip amount based on subtotal ratio

5. `calculateParticipantTotal(subtotal: number, tax: number, tip: number): number`
   - Simple sum of all components

All prices in cents (integers). Export all functions.
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit</verify>
  <done>All calculation functions exported and type-safe</done>
</task>

<task type="auto">
  <name>Task 2: Create participantTotals query</name>
  <files>convex/participants.ts</files>
  <action>
Add a new query `getTotals` to convex/participants.ts that returns per-participant breakdown:

```typescript
export const getTotals = query({
  args: { sessionId: v.id("sessions") },
  handler: async (ctx, args) => {
    // 1. Fetch session, items, claims, participants
    // 2. For each participant:
    //    - Calculate their item subtotal (sum of their claim shares)
    //    - Calculate their tax share (proportional)
    //    - Calculate their tip share (based on session tipType/tipValue)
    //    - Calculate total
    // 3. Also calculate unclaimed items total
    // 4. Return array of { participantId, name, isHost, subtotal, tax, tip, total, claimedItems }
    //    Plus { unclaimedTotal, unclaimedItems }
  },
});
```

Key implementation details:
- Use calculations.ts functions for all math
- claimedItems: array of { itemId, itemName, sharePrice, claimCount }
- unclaimedItems: items with 0 claims (not factored into anyone's share)
- Handle missing session.tax (default 0), missing tipType/tipValue (default 0)
- Sort participants by joinedAt (host first)

This query updates in real-time as claims change.
  </action>
  <verify>
Run dev server and verify query returns data:
```bash
npx convex dev &
# In another terminal, check no TypeScript errors
npx tsc --noEmit
```
  </verify>
  <done>participantTotals query returns complete breakdown for all participants with real-time updates</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes with no errors
- [ ] `npx convex dev` runs without errors
- [ ] calculations.ts exports all 5 functions
- [ ] participants.getTotals query is callable
</verification>

<success_criteria>

- All calculation functions implemented with proper rounding
- participantTotals query returns complete breakdown
- Unclaimed items tracked separately
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-calculation-engine/06-01-SUMMARY.md`
</output>
