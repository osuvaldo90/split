---
phase: 14-access-control
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/sessions.ts
  - convex/items.ts
  - convex/claims.ts
autonomous: true

must_haves:
  truths:
    - "updateTip rejects non-host participants"
    - "updateTax rejects non-host participants"
    - "updateGratuity rejects non-host participants"
    - "items.remove rejects non-host participants"
    - "items.addBulk rejects non-host participants"
  artifacts:
    - path: ".planning/phases/14-access-control/14-04-AUDIT.md"
      provides: "Host-only authorization audit report"
      min_lines: 30
  key_links:
    - from: "host-only mutations"
      to: "participants.isHost"
      via: "isHost check before mutation"
      pattern: "participant\\.isHost"
---

<objective>
Audit existing host-only checks to confirm ACCESS-03 compliance.

Purpose: ACCESS-03 requires tax and tip mutations enforce host-only restriction. This plan audits the existing implementation and documents findings. The host-only checks were implemented in earlier phases - this confirms they're complete and correct.

Output: Audit report confirming host-only checks are in place, or fixes if gaps found.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Mutations to audit
@convex/sessions.ts
@convex/items.ts
@convex/claims.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit host-only mutations and create report</name>
  <files>.planning/phases/14-access-control/14-04-AUDIT.md</files>
  <action>
Review each mutation that should be host-only and document findings:

**Expected host-only mutations:**
1. sessions.updateTip - host sets tip percentage/amount
2. sessions.updateTax - host adjusts tax amount
3. sessions.updateGratuity - host sets auto-gratuity from receipt
4. items.remove - host can delete items (delete button only shown to host)
5. items.addBulk - host uploads receipt (replaces all items)
6. claims.unclaimByHost - host can remove anyone's claim

**For each mutation, verify:**
1. Accepts participantId (or hostParticipantId) parameter
2. Fetches participant record from database
3. Checks `participant.isHost === true`
4. Throws error if not host: "Only the host can..."
5. Verifies participant belongs to target session

Create audit report at `.planning/phases/14-access-control/14-04-AUDIT.md` with:
- Table of mutations and their status (✓ compliant / ✗ needs fix)
- Code snippets showing authorization checks
- Any gaps or recommendations

If any gaps found, fix them in the same task.
  </action>
  <verify>Audit report exists, all host-only mutations have proper checks</verify>
  <done>Host-only authorization audit complete, all mutations verified</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Audit report created at 14-04-AUDIT.md
- [ ] All 6 host-only mutations verified to have proper checks
- [ ] Each mutation: gets participant, checks isHost, checks session match
- [ ] No gaps in host-only enforcement
</verification>

<success_criteria>

- Audit confirms updateTip, updateTax, updateGratuity are host-only
- Audit confirms items.remove, items.addBulk are host-only
- Audit confirms claims.unclaimByHost is host-only
- Any gaps identified are fixed
- Report documents authorization pattern
</success_criteria>

<output>
After completion, create `.planning/phases/14-access-control/14-04-SUMMARY.md`
</output>
