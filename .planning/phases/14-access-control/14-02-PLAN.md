---
phase: 14-access-control
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/items.ts
  - convex/claims.ts
  - convex/sessions.ts
autonomous: true

must_haves:
  truths:
    - "items.add mutation rejects non-participants"
    - "items.update mutation rejects non-participants"
    - "claims.claim mutation rejects non-participants"
    - "sessions.updateTotals mutation rejects non-participants"
  artifacts:
    - path: "convex/items.ts"
      provides: "Participant-verified item mutations"
      contains: "verifyParticipant"
    - path: "convex/claims.ts"
      provides: "Participant-verified claim mutation"
      contains: "verifyParticipant"
    - path: "convex/sessions.ts"
      provides: "Participant-verified updateTotals mutation"
      contains: "verifyParticipant"
  key_links:
    - from: "mutations"
      to: "participants table"
      via: "participantId lookup before write"
      pattern: "ctx\\.db\\.get\\(args\\.participantId\\)"
---

<objective>
Add participant authorization checks to all mutations that currently lack them.

Purpose: ACCESS-02 requires that all Convex mutations verify the caller is a joined participant before executing. Currently items.add, items.update, claims.claim, and sessions.updateTotals don't verify caller is a participant.

Output: All mutations require and verify participantId belongs to the session before allowing writes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Current Convex mutations
@convex/items.ts
@convex/claims.ts
@convex/sessions.ts
@convex/participants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add participantId verification to items mutations</name>
  <files>convex/items.ts</files>
  <action>
Modify items.ts to require and verify participantId for add and update mutations:

**items.add:**
1. Add `participantId: v.id("participants")` to args
2. Verify participant exists: `const participant = await ctx.db.get(args.participantId)`
3. Verify participant belongs to this session: `participant.sessionId === args.sessionId`
4. Throw descriptive error if verification fails: "Not authorized to add items to this session"

**items.update:**
1. Add `participantId: v.id("participants")` to args
2. After fetching item and session, verify participant exists and belongs to item's session
3. Throw descriptive error if verification fails: "Not authorized to edit items in this session"

Keep existing validation logic. The participant check happens early, before any writes.
  </action>
  <verify>npx convex dev compiles successfully, items mutations require participantId</verify>
  <done>items.add and items.update verify caller is a participant in the session</done>
</task>

<task type="auto">
  <name>Task 2: Add participantId verification to claims.claim</name>
  <files>convex/claims.ts</files>
  <action>
The claims.claim mutation already receives participantId but doesn't verify it belongs to the session.

Modify claims.claim:
1. After receiving args, verify the participant exists: `const participant = await ctx.db.get(args.participantId)`
2. Verify participant is not null and belongs to the session: `participant.sessionId === args.sessionId`
3. Throw error if verification fails: "Not authorized to claim items in this session"
4. Keep existing duplicate claim check and insert logic

Note: claims.unclaim already has authorization checks (caller is self or host).
  </action>
  <verify>npx convex dev compiles successfully, claims.claim verifies participant</verify>
  <done>claims.claim verifies caller is a participant in the session</done>
</task>

<task type="auto">
  <name>Task 3: Add participantId verification to sessions.updateTotals</name>
  <files>convex/sessions.ts</files>
  <action>
Modify sessions.updateTotals to require participant verification:

1. Add `participantId: v.id("participants")` to args
2. Verify participant exists and belongs to this session
3. Throw error if verification fails: "Not authorized to update session totals"
4. Keep existing validation for subtotal and tax amounts

Note: This is called after OCR parsing to set initial totals. The host typically triggers this, but any participant could in theory call it (for manual total adjustment). Since it's not host-only by design, we just need participant verification.
  </action>
  <verify>npx convex dev compiles successfully, updateTotals requires participantId</verify>
  <done>sessions.updateTotals verifies caller is a participant</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx convex dev` compiles without errors
- [ ] All modified mutations have participantId in their args
- [ ] Each mutation verifies participant exists and belongs to target session
- [ ] Descriptive error messages for authorization failures
</verification>

<success_criteria>

- items.add requires and verifies participantId
- items.update requires and verifies participantId
- claims.claim verifies participantId belongs to session
- sessions.updateTotals requires and verifies participantId
- All mutations throw clear errors for unauthorized callers
</success_criteria>

<output>
After completion, create `.planning/phases/14-access-control/14-02-SUMMARY.md`
</output>
