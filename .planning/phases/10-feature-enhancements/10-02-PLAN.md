---
phase: 10-feature-enhancements
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/billHistory.ts
  - src/pages/Home.tsx
autonomous: true
---

<objective>
Add bill history to home screen showing recent bills from this device.

Purpose: Users should see their recent bills on the home screen for quick access - rejoin active bills or view summaries of closed ones.
Output: localStorage-based bill history displayed on Home page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-feature-enhancements/10-CONTEXT.md

@src/pages/Home.tsx
@src/lib/sessionStorage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bill history storage utilities</name>
  <files>src/lib/billHistory.ts</files>
  <action>
    Create new file src/lib/billHistory.ts with:

    1. Type definitions:
       ```typescript
       interface BillHistoryEntry {
         code: string;           // Session code for rejoining
         createdAt: number;      // Unix timestamp
         participantName: string; // User's name in this bill
         participantId: string;  // For session persistence check
         merchantName?: string;  // From receipt if available
         total?: number;         // Final total in cents (if known)
       }
       ```

    2. Storage key: `split_bill_history`

    3. Functions:
       - `getBillHistory(): BillHistoryEntry[]` - returns array sorted by createdAt desc, max 10 entries
       - `addBillToHistory(entry: Omit<BillHistoryEntry, 'createdAt'>): void` - adds new entry, dedupes by code
       - `updateBillTotal(code: string, total: number): void` - update total when known
       - `clearBillHistory(): void` - for testing/reset

    4. Implementation notes:
       - Use try/catch around localStorage operations
       - Limit to 10 most recent entries
       - When adding, check if code exists and update instead of duplicate
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit</verify>
  <done>Bill history utilities created with get/add/update/clear functions</done>
</task>

<task type="auto">
  <name>Task 2: Save bills to history when creating/joining</name>
  <files>src/pages/Home.tsx, src/pages/Join.tsx</files>
  <action>
    1. In Home.tsx, after successful session creation:
       - Import addBillToHistory from billHistory
       - After createSession succeeds, call addBillToHistory with:
         - code: returned code
         - participantName: hostName
         - participantId: hostParticipantId
         - merchantName: undefined (not known yet)

    2. In Join.tsx, after successful join:
       - Import addBillToHistory from billHistory
       - After successful join mutation, call addBillToHistory with:
         - code: session code from URL/input
         - participantName: user's entered name
         - participantId: returned participant ID
         - merchantName: undefined

    This ensures history is populated when users interact with bills.
  </action>
  <verify>Create a session - check localStorage for split_bill_history entry</verify>
  <done>Bills are saved to history when created or joined</done>
</task>

<task type="auto">
  <name>Task 3: Display bill history on Home page</name>
  <files>src/pages/Home.tsx</files>
  <action>
    Add bill history section below the "Start splitting" button:

    1. Import getBillHistory, useEffect, and Link from react-router-dom

    2. Add state: `const [history, setHistory] = useState<BillHistoryEntry[]>([])`

    3. Load history on mount:
       ```typescript
       useEffect(() => {
         setHistory(getBillHistory());
       }, []);
       ```

    4. Render history section (only if history.length > 0):
       ```jsx
       {history.length > 0 && (
         <div className="mt-8 space-y-3">
           <h2 className="text-sm font-medium text-gray-500 uppercase tracking-wide">
             Recent Bills
           </h2>
           <div className="space-y-2">
             {history.map((bill) => (
               <Link
                 key={bill.code}
                 to={`/session/${bill.code}`}
                 className="block p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
               >
                 <div className="flex justify-between items-center">
                   <div>
                     <div className="font-medium text-gray-900">
                       {bill.merchantName || `Bill ${bill.code}`}
                     </div>
                     <div className="text-sm text-gray-500">
                       {new Date(bill.createdAt).toLocaleDateString()}
                     </div>
                   </div>
                   {bill.total && (
                     <div className="text-lg font-semibold text-gray-900">
                       ${(bill.total / 100).toFixed(2)}
                     </div>
                   )}
                 </div>
               </Link>
             ))}
           </div>
         </div>
       )}
       ```

    5. Styling notes:
       - Gray background cards for each entry
       - Show merchant name if available, otherwise "Bill {code}"
       - Show date in local format
       - Show total if available (right-aligned)
       - Tap navigates to session (will rejoin if active, show error if closed)
  </action>
  <verify>
    1. Create a session, return to home
    2. Recent Bills section appears
    3. Tapping entry navigates to session
  </verify>
  <done>
    - Bill history displays on Home page
    - Shows merchant/date/total
    - Tapping navigates to session
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] Creating a session adds it to history
- [ ] Joining a session adds it to history
- [ ] Home page shows Recent Bills section
- [ ] Tapping a bill entry navigates to that session
</verification>

<success_criteria>
- All tasks completed
- Bill history persists in localStorage
- Recent bills visible on home screen
- Navigation to bills works
</success_criteria>

<output>
After completion, create `.planning/phases/10-feature-enhancements/10-02-SUMMARY.md`
</output>
