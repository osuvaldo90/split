---
phase: 10-feature-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/actions/parseReceipt.ts
  - convex/schema.ts
  - convex/sessions.ts
  - src/components/TaxTipSettings.tsx
  - src/components/ReceiptCapture.tsx
autonomous: true
---

<objective>
Add auto-gratuity detection from receipts and display as separate line in TaxTipSettings.

Purpose: Receipts with included gratuity (common for large parties) should be detected during OCR and shown as a distinct, always-visible field separate from optional tip.
Output: Auto-gratuity extracted from receipts, stored in session, displayed on tax/tip screen.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-feature-enhancements/10-CONTEXT.md

@convex/actions/parseReceipt.ts
@convex/schema.ts
@convex/sessions.ts
@src/components/TaxTipSettings.tsx
@src/components/ReceiptCapture.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add gratuity extraction to OCR prompt and types</name>
  <files>convex/actions/parseReceipt.ts</files>
  <action>
    1. Update RECEIPT_PROMPT to include gratuity extraction:
       - Add "gratuity" field to the expected JSON format (number or null)
       - Add rule: "gratuity: auto-gratuity or service charge if present, otherwise null"
       - Add examples: "Look for 'Gratuity', 'Service Charge', 'Auto Gratuity', '18% Gratuity' etc."

    2. Update ParsedReceipt type to include gratuity:
       - Add `gratuity: number | null` to the success type

    The gratuity should be in dollars (like other prices in the response).
  </action>
  <verify>TypeScript compiles without errors: npx tsc --noEmit</verify>
  <done>ParsedReceipt type includes gratuity field, prompt instructs extraction</done>
</task>

<task type="auto">
  <name>Task 2: Add gratuity field to session schema and mutations</name>
  <files>convex/schema.ts, convex/sessions.ts</files>
  <action>
    1. In convex/schema.ts, add to sessions table:
       - `gratuity: v.optional(v.number())` - in cents, like other money fields

    2. In convex/sessions.ts, add updateGratuity mutation:
       - Args: sessionId, gratuity (number in cents)
       - Updates session's gratuity field
       - Only host can update (check participant.isHost)

    3. Ensure the create mutation can accept initial gratuity if needed (optional).
  </action>
  <verify>npx convex dev runs without schema errors</verify>
  <done>Session schema has gratuity field, mutation to update it exists</done>
</task>

<task type="auto">
  <name>Task 3: Pass gratuity from OCR result to session</name>
  <files>src/components/ReceiptCapture.tsx</files>
  <action>
    In ReceiptCapture.tsx, when processing OCR result:

    1. After successful parse, if result.gratuity exists and is > 0:
       - Convert from dollars to cents (Math.round(result.gratuity * 100))
       - Call updateGratuity mutation with the session ID and gratuity value

    2. The gratuity should be saved alongside items and tax from the receipt.

    Import the updateGratuity mutation and call it when gratuity is detected.
  </action>
  <verify>Upload a receipt - gratuity field should be populated in session (check Convex dashboard)</verify>
  <done>OCR-detected gratuity is saved to session</done>
</task>

<task type="auto">
  <name>Task 4: Display auto-gratuity in TaxTipSettings</name>
  <files>src/components/TaxTipSettings.tsx</files>
  <action>
    Add auto-gratuity display section between Tax and Tip sections:

    1. Update Session interface to include `gratuity?: number`

    2. Add "Auto-Gratuity" section (always visible, even if $0.00):
       - Gray background card like Tax section
       - Shows dollar amount (session.gratuity / 100 formatted)
       - If gratuity exists and > 0, show with "(from receipt)" label
       - If $0.00, still show but without label
       - Host can edit this field (same pattern as tax input)
       - Non-host sees read-only value

    3. Update Group Total preview to include gratuity:
       - Add gratuity line in breakdown
       - Total = subtotal + tax + gratuity + tip

    4. For calculations (tipPreview and total), gratuity is added AFTER tip calculation:
       - Tip is calculated on subtotal (or subtotal+tax depending on tipType)
       - Gratuity is a flat addition to the final total
       - This matches real-world behavior where auto-gratuity is separate from optional tip
  </action>
  <verify>
    1. npm run dev and visit session page
    2. Tax & Tip tab shows Auto-Gratuity section between Tax and Tip
    3. Group Total includes gratuity in breakdown
  </verify>
  <done>
    - Auto-Gratuity section always visible in TaxTipSettings
    - Displays detected value with "(from receipt)" when > 0
    - Host can edit, non-host sees read-only
    - Group Total includes gratuity
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npx convex dev` runs without errors
- [ ] OCR prompt includes gratuity extraction instructions
- [ ] Session schema has gratuity field
- [ ] TaxTipSettings shows Auto-Gratuity section (visible even at $0)
- [ ] Group Total includes gratuity in calculation
</verification>

<success_criteria>
- All tasks completed
- Auto-gratuity detected from receipts when present
- Always-visible gratuity line in tax/tip settings
- Clear distinction between detected gratuity and optional tip
- Correct total calculation including gratuity
</success_criteria>

<output>
After completion, create `.planning/phases/10-feature-enhancements/10-01-SUMMARY.md`
</output>
