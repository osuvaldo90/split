---
phase: 10.1-bug-fixes-ux
plan: 01
subsystem: api
tags: [convex, calculations, tax, gratuity, proportional-distribution]

# Dependency graph
requires:
  - phase: 06-calculation-engine
    provides: distributeWithRemainder helper for proportional distribution
provides:
  - Correct tax/gratuity distribution using bill subtotal as denominator
  - Unclaimed items' tax/gratuity not assigned to anyone
affects: [summary-display, calculation-engine]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Phantom entry pattern: include unclaimed as last element, slice to remove"

key-files:
  created: []
  modified:
    - convex/participants.ts

key-decisions:
  - "Use phantom entry for unclaimed items in distribution rather than modifying distributeWithRemainder"
  - "Calculate billSubtotal separately from groupSubtotal (claimed only)"

patterns-established:
  - "Phantom entry pattern: append unclaimed portion, distribute, slice off last element"

# Metrics
duration: 1min
completed: 2026-01-15
---

# Phase 10.1 Plan 01: Fix Tax Distribution Summary

**Tax and gratuity now distributed proportionally to participant's share of the TOTAL bill subtotal, not just claimed items**

## Performance

- **Duration:** 1 min
- **Started:** 2026-01-15T06:31:59Z
- **Completed:** 2026-01-15T06:32:57Z
- **Tasks:** 1
- **Files modified:** 1

## Accomplishments

- Fixed critical bug where claiming partial items meant paying 100% of tax
- Tax distributed as: participantTax = (participantSubtotal / billSubtotal) x totalTax
- Same fix applied to gratuity distribution
- Unclaimed items' tax/gratuity portion goes to no one (correct behavior)

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix tax distribution to use bill subtotal** - `07c7938` (fix)

## Files Created/Modified

- `convex/participants.ts` - Fixed getTotals query to use bill subtotal (all items) as denominator for tax and gratuity distribution

## Decisions Made

1. **Phantom entry pattern** - Rather than modifying distributeWithRemainder to accept a separate total, we append the unclaimed portion as a "phantom" last element, distribute, then slice off the last element. This keeps the helper function generic and the fix localized.

2. **Calculate billSubtotal separately** - The existing groupSubtotal only includes claimed items. We calculate billSubtotal from all items separately to get the correct denominator.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

**Pre-existing build errors in Home.tsx:** The build fails due to unused variables in `src/pages/Home.tsx` from work-in-progress on the "combine join bill into home page" todo. These are unrelated to this plan. Convex typecheck passes, confirming my changes compile correctly.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Tax distribution bug fixed
- Ready for Plan 02: Combine join bill into home page
- Note: Home.tsx has unused variables that will need cleanup when implementing Plan 02

---
*Phase: 10.1-bug-fixes-ux*
*Completed: 2026-01-15*
