---
phase: 10.1-bug-fixes-ux
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [convex/participants.ts]
autonomous: true
---

<objective>
Fix tax distribution calculation to use bill subtotal as denominator.

Purpose: Ensure tax is distributed proportionally to each participant's share of the TOTAL bill subtotal, not just their share of claimed items. This is critical for user trust in the calculations.
Output: Corrected tax distribution that properly handles partial claiming scenarios.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10.1-bug-fixes-ux/10.1-CONTEXT.md

@convex/participants.ts
@convex/calculations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix tax distribution to use bill subtotal</name>
  <files>convex/participants.ts</files>
  <action>
In getTotals query, the current code at line 181-184:
```typescript
const participantSubtotals = participants.map(
  (p) => participantData.get(p._id)?.subtotal ?? 0
);
const taxShares = distributeWithRemainder(totalTax, participantSubtotals);
```

This distributes tax proportionally among participants based on their claimed subtotals relative to the SUM of claimed subtotals. This is wrong when items are unclaimed.

BUG: If bill subtotal is $48, osvi claims $20, other claims $0:
- Current: osvi pays 100% of tax ($20/$20 = 100%)
- Correct: osvi pays 41.67% of tax ($20/$48 = 41.67%)

FIX: Pass groupSubtotal to distributeWithRemainder as the total, not the sum of proportions. Create a new helper or modify the call to ensure tax is calculated as:
`participantTax = (participantSubtotal / billSubtotal) × totalTax`

Option 1 (preferred): Create wrapper arrays that include the unclaimed portion:
```typescript
// Calculate tax shares using bill subtotal as denominator
// Add a "phantom" entry for unclaimed items to ensure correct proportions
const participantSubtotals = participants.map(
  (p) => participantData.get(p._id)?.subtotal ?? 0
);
const claimedSubtotal = participantSubtotals.reduce((sum, s) => sum + s, 0);
const unclaimedSubtotal = groupSubtotal - claimedSubtotal;

// Include unclaimed portion in distribution calculation
const allSubtotals = [...participantSubtotals, unclaimedSubtotal];
const allTaxShares = distributeWithRemainder(totalTax, allSubtotals);
// Remove the unclaimed portion's tax share (last element)
const taxShares = allTaxShares.slice(0, -1);
```

Apply same fix to gratuity distribution (line 187).

Important: groupSubtotal only includes CLAIMED items currently. Check line 171:
```typescript
groupSubtotal += item.price;
```
This is inside the `if (claimants.length === 0) continue` block, so unclaimed items DON'T add to groupSubtotal.

Actually, looking more carefully - the bug is different:
- Line 136: `let groupSubtotal = 0;`
- Lines 138-149: For items with claimants.length === 0, we push to unclaimedItems and `continue` (skip adding to groupSubtotal)
- Line 171: `groupSubtotal += item.price;` only runs for claimed items

So groupSubtotal IS only claimed items total. We need TOTAL bill subtotal (all items).

FIX: Calculate total bill subtotal separately:
```typescript
// Calculate total bill subtotal (all items, claimed or not)
const billSubtotal = items.reduce((sum, item) => sum + item.price, 0);
```

Then use billSubtotal for tax distribution:
```typescript
// Include unclaimed portion in distribution to get correct proportions
const claimedSubtotal = participantSubtotals.reduce((sum, s) => sum + s, 0);
const unclaimedSubtotal = billSubtotal - claimedSubtotal;
const allSubtotals = [...participantSubtotals, unclaimedSubtotal];
const allTaxShares = distributeWithRemainder(totalTax, allSubtotals);
const taxShares = allTaxShares.slice(0, -1);
```

Apply same pattern to gratuity distribution.
  </action>
  <verify>
Build succeeds: `cd /Users/osvi/src/split && npm run build`
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
Tax and gratuity distributed proportionally to participant's share of TOTAL bill subtotal:
- If osvi claims $20 of $48 bill with $4.80 tax → osvi pays $2.00 tax (41.67%)
- If nobody claims anything → everyone pays $0 tax
- If one person claims everything → they pay 100% of tax
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] `npx tsc --noEmit` passes
- [ ] Manual test: Create bill with $48 subtotal, $4.80 tax. One person claims $20 of items. Their tax should be ~$2.00, not $4.80.
</verification>

<success_criteria>

- Tax distribution uses bill subtotal (all items) as denominator
- Gratuity distribution uses bill subtotal (all items) as denominator
- Unclaimed items don't assign their tax portion to anyone
- Math is correct: participantTax = (participantSubtotal / billSubtotal) × totalTax
</success_criteria>

<output>
After completion, create `.planning/phases/10.1-bug-fixes-ux/10.1-01-SUMMARY.md`
</output>
