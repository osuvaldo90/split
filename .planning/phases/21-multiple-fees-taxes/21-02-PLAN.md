---
phase: 21-multiple-fees-taxes
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - convex/actions/parseReceipt.ts
  - src/components/TaxTipSettings.tsx
  - src/components/Summary.tsx
  - src/pages/Session.tsx
autonomous: true

must_haves:
  truths:
    - "Receipt scan extracts multiple labeled fees"
    - "User sees individual fees in Taxes & Fees section"
    - "Host can edit, add, and remove fees"
    - "Summary shows 'Taxes & Fees' instead of 'Tax'"
  artifacts:
    - path: "convex/actions/parseReceipt.ts"
      provides: "Multi-fee extraction"
      contains: "fees.*array"
    - path: "src/components/TaxTipSettings.tsx"
      provides: "Multi-fee UI editing"
      contains: "Taxes & Fees"
    - path: "src/components/Summary.tsx"
      provides: "Updated breakdown labels"
      contains: "Taxes & Fees"
  key_links:
    - from: "src/components/TaxTipSettings.tsx"
      to: "convex/fees.ts"
      via: "useMutation calls"
      pattern: "api\\.fees\\.(add|update|remove)"
    - from: "src/pages/Session.tsx"
      to: "convex/fees.ts"
      via: "useQuery for fees"
      pattern: "api\\.fees\\.listBySession"
---

<objective>
Update OCR to extract multiple fees, update UI to display and edit them

Purpose: Complete the user-facing experience - receipt scanning captures all fee types with exact labels, and users can view/edit individual fees in a unified "Taxes & Fees" section.

Output: Working end-to-end flow from receipt scan to fee display and editing
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-multiple-fees-taxes/21-CONTEXT.md
@.planning/phases/21-multiple-fees-taxes/21-RESEARCH.md
@.planning/phases/21-multiple-fees-taxes/21-01-SUMMARY.md

# Key files to reference
@convex/actions/parseReceipt.ts
@src/components/TaxTipSettings.tsx
@src/components/Summary.tsx
@src/pages/Session.tsx
@convex/fees.ts (from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update parseReceipt to extract multiple fees</name>
  <files>
    convex/actions/parseReceipt.ts
  </files>
  <action>
1. Update RECEIPT_VALIDATION_PROMPT:
   - Replace tax extraction with fees array extraction
   - Add guidance for extracting EXACT labels from receipt (per CONTEXT.md)
   - Examples: "Philadelphia Sales Tax", "Kitchen Appreciation Fee", "Liquor Tax"
   - Include instruction to keep each fee separate, not combine them
   - If single "Tax" line on receipt, use label "Tax"
   - Empty array if no taxes/fees visible

2. Update receiptValidationSchema:
   - Replace "tax" field with "fees" array
   - Each fee object: { label: string, amount: number }
   - Both fields required, additionalProperties: false
   - Amount is in dollars (like other prices in schema)

3. Update ReceiptValidationResponse type:
   - Replace tax: number | null with fees: Array<{ label: string; amount: number }>

4. Update ParsedReceipt return type:
   - Replace tax: number | null with fees: Array<{ label: string; amount: number }>

5. In the action handler, the response.data now has fees array instead of tax
   - No special handling needed, structured outputs guarantees the array

Prompt guidance to add (from RESEARCH.md):
```
- fees: Extract ALL tax and fee line items from the receipt as an array
  - Each fee should have:
    - label: The EXACT text from the receipt (e.g., "Philadelphia Sales Tax", "Kitchen Appreciation Fee", "Liquor Tax")
    - amount: The dollar amount for that fee
  - Include all types: sales tax, liquor tax, service fees, gratuity charges, surcharges, etc.
  - If the receipt shows a single "Tax" line, use label "Tax"
  - If no taxes/fees are visible, return an empty array []
  - Do NOT combine multiple fees into one - keep them separate
```
  </action>
  <verify>
    - TypeScript compiles: `npx tsc --noEmit`
    - Grep parseReceipt.ts for "fees" array in schema
    - Grep for fee extraction prompt guidance
  </verify>
  <done>
    - JSON schema has fees array instead of single tax
    - Prompt instructs extraction of exact receipt labels
    - ParsedReceipt type updated to return fees array
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TaxTipSettings for multiple fees</name>
  <files>
    src/components/TaxTipSettings.tsx
    src/pages/Session.tsx
  </files>
  <action>
1. Update Session.tsx:
   - Add useQuery for fees: api.fees.listBySession
   - Pass fees array to TaxTipSettings component

2. Rewrite TaxTipSettings to handle multiple fees:

Section structure (per CONTEXT.md):
- "Taxes & Fees" section (replaces "Tax" section)
  - List of fee rows, each with label and amount
  - "Add fee" button (host only)
- "Auto-Gratuity" section (unchanged)
- "Tip" section (unchanged)

Fee list behavior:
- Each fee row shows: label input, $ amount input, delete button (X)
- Use local state for editing, sync on blur (existing pattern)
- Host can edit label and amount
- Non-host sees read-only display

Add fee:
- "Add fee" button at bottom of fees list
- Creates new fee with label "New fee" and amount 0
- Immediately focuses the label input for editing

Remove fee:
- X button on each fee row (host only)
- Calls fees.remove mutation

Mutations to use (from fees.ts):
- api.fees.add - for new fees
- api.fees.update - for editing existing
- api.fees.remove - for deleting

Props update:
- Remove session.tax prop dependency
- Add fees: Array<{ _id: Id<"fees">, label: string, amount: number }>

State management:
- Track editing state per fee (by fee._id)
- Sync from props on external changes (useEffect pattern already in component)

Calculate total fees for preview:
- Sum all fees amounts for the group total display
  </action>
  <verify>
    - `npm run build` compiles without errors
    - Check TaxTipSettings.tsx for "Taxes & Fees" section header
    - Check for fees.add, fees.update, fees.remove mutation calls
    - Check Session.tsx for fees query
  </verify>
  <done>
    - TaxTipSettings displays multiple fee rows
    - Host can add, edit, and remove fees
    - Non-host sees read-only fee list
    - Section labeled "Taxes & Fees"
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Summary breakdown labels</name>
  <files>
    src/components/Summary.tsx
  </files>
  <action>
1. In the participant breakdown row (line ~124-135):
   - Change "Tax" label to "Taxes & Fees"
   - Display participant.tax (which now represents sum of all fee shares)

2. The calculation is already correct (Plan 01 updated getTotals):
   - participant.tax is the sum of their share of all fees
   - No calculation changes needed in Summary

3. Ensure gratuity still shows separately (it does)

4. Optional enhancement: If fees breakdown is needed in expanded view, can show individual fees
   - For now, just show total "Taxes & Fees" in the summary line (keep it simple)
  </action>
  <verify>
    - `npm run build` compiles
    - Grep Summary.tsx for "Taxes & Fees"
    - Verify participant.tax is still displayed (now represents all fees)
  </verify>
  <done>
    - Summary shows "Taxes & Fees" instead of "Tax"
    - Breakdown calculation remains correct
  </done>
</task>

</tasks>

<verification>
End-to-end manual test flow:
1. Create new session, upload receipt with multiple fees
2. Verify fees extracted with exact labels from receipt
3. Verify TaxTipSettings shows all fees in "Taxes & Fees" section
4. Edit a fee amount, verify it saves
5. Add a new fee, verify it appears
6. Remove a fee, verify it disappears
7. Check Summary tab shows "Taxes & Fees" label with correct total
8. Test existing session (with old tax field) still works

Build verification:
- `npm run build` succeeds
- `npx convex dev` shows no errors
</verification>

<success_criteria>
- Receipt OCR extracts multiple fees with exact labels
- TaxTipSettings displays editable fee list under "Taxes & Fees" header
- Host can add, edit, and remove individual fees
- Summary shows "Taxes & Fees" breakdown
- Existing sessions with single tax field continue working
</success_criteria>

<output>
After completion, create `.planning/phases/21-multiple-fees-taxes/21-02-SUMMARY.md`
</output>
