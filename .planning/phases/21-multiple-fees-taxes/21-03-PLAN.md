---
phase: 21-multiple-fees-taxes
plan: 03
type: execute
wave: 1
depends_on: ["21-02"]
files_modified:
  - src/pages/Session.tsx
  - src/components/TaxTipSettings.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Legacy sessions with session.tax display tax value in TaxTipSettings"
    - "New sessions with fees table entries continue to work unchanged"
    - "Host can still edit real fees (synthetic legacy fee is read-only display)"
    - "Host cannot accidentally trigger mutations on synthetic legacy fees"
  artifacts:
    - path: "src/pages/Session.tsx"
      provides: "displayFees computation with legacy fallback"
      contains: "session.tax"
    - path: "src/components/TaxTipSettings.tsx"
      provides: "Read-only rendering for synthetic legacy fees"
      contains: "legacy-"
  key_links:
    - from: "src/pages/Session.tsx"
      to: "src/components/TaxTipSettings.tsx"
      via: "displayFees prop"
      pattern: "fees=\\{displayFees\\}"
    - from: "src/components/TaxTipSettings.tsx"
      to: "fee._id check"
      via: "isLegacyFee detection"
      pattern: "startsWith.*legacy-"
---

<objective>
Fix legacy session backward compatibility for fees display

Purpose: Legacy sessions (pre-Phase 21) store tax in session.tax field, but TaxTipSettings shows empty because it only receives fees from the fees table query. The calculation logic in getTotals already handles this fallback, but the UI display does not.

Output: Session.tsx computes displayFees that falls back to session.tax when fees table is empty, and TaxTipSettings renders synthetic legacy fees as read-only to prevent mutation failures.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/21-multiple-fees-taxes/21-UAT.md (gap diagnosis)
@src/pages/Session.tsx (fees query and TaxTipSettings usage)
@src/components/TaxTipSettings.tsx (Fee interface definition, fee rendering logic)
@convex/participants.ts (getTotals fallback logic reference, lines 220-241)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add displayFees computation with legacy fallback</name>
  <files>src/pages/Session.tsx</files>
  <action>
Add a useMemo hook after the existing fees query (line ~107) to compute displayFees:

```typescript
// Compute display fees with legacy fallback
// New sessions: use fees from fees table
// Legacy sessions: synthesize from session.tax if fees table is empty
const displayFees = useMemo(() => {
  // If fees table has entries, use them
  if (fees && fees.length > 0) {
    return fees;
  }
  // Legacy fallback: synthesize fee from session.tax
  if (session?.tax && session.tax > 0) {
    return [{
      _id: "legacy-tax" as Id<"fees">,
      label: "Tax",
      amount: session.tax,
    }];
  }
  // No fees
  return [];
}, [fees, session?.tax]);
```

Then update the TaxTipSettings component usage (around line 539-545) to pass displayFees instead of fees:

Change from:
```typescript
<TaxTipSettings
  session={session}
  fees={fees ?? []}
  ...
```

To:
```typescript
<TaxTipSettings
  session={session}
  fees={displayFees}
  ...
```

IMPORTANT: Keep the `fees` query as-is (it's still needed for the displayFees computation). Only change what gets passed to TaxTipSettings.
  </action>
  <verify>
TypeScript compiles: `cd /Users/osvi/src/split && npx tsc --noEmit`
  </verify>
  <done>
- Session.tsx computes displayFees with legacy fallback
- TaxTipSettings receives displayFees prop
  </done>
</task>

<task type="auto">
  <name>Task 2: Render synthetic legacy fees as read-only in TaxTipSettings</name>
  <files>src/components/TaxTipSettings.tsx</files>
  <action>
The fee rendering loop (lines 239-288) currently shows editable inputs for ALL fees when isHost is true. Synthetic legacy fees (with IDs starting with "legacy-") must be rendered as read-only to prevent mutation failures.

In the fees.map() block (around line 239), add a check for legacy fees:

```typescript
{fees.map((fee) => {
  const input = feeInputs.get(fee._id) || { label: fee.label, amount: (fee.amount / 100).toFixed(2) };
  const isLastAdded = fee._id === newFeeIdRef.current;
  // Synthetic legacy fees should always render as read-only
  const isLegacyFee = typeof fee._id === 'string' && fee._id.startsWith('legacy-');

  return (
    <div key={fee._id} className="flex items-center gap-2">
      {isHost && !isLegacyFee ? (
        // ... existing editable inputs for real fees (lines 247-278)
      ) : (
        // Read-only display for non-host OR legacy fees
        <>
          <span className="flex-1 text-gray-700 text-sm">{fee.label}</span>
          <span className="text-gray-900 font-medium">${(fee.amount / 100).toFixed(2)}</span>
        </>
      )}
    </div>
  );
})}
```

The key change is updating the condition from `{isHost ? (` to `{isHost && !isLegacyFee ? (`.

This ensures:
1. Real fees: Host sees editable inputs, non-host sees read-only
2. Legacy fees: Everyone sees read-only (no edit/remove buttons)
3. No mutation calls possible for synthetic IDs
  </action>
  <verify>
1. TypeScript compiles: `cd /Users/osvi/src/split && npx tsc --noEmit`
2. App builds: `npm run build`
  </verify>
  <done>
- Synthetic legacy fees render as read-only even for hosts
- No edit inputs or remove button shown for legacy fees
- Mutation handlers cannot be triggered for synthetic fee IDs
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - TypeScript compilation passes
2. `npm run build` - Production build succeeds
3. Open legacy session in browser - "Tax" appears in Taxes & Fees section as read-only text (no inputs)
4. Open new session, scan receipt with fees - multiple fees display with editable inputs for host (regression check)
5. As host on legacy session, verify no edit/remove buttons appear for the "Tax" legacy fee
</verification>

<success_criteria>
- Legacy sessions show their tax value in the TaxTipSettings "Taxes & Fees" section as read-only
- Host cannot edit or remove the synthetic legacy fee (no inputs/buttons shown)
- New sessions with fees table entries work unchanged (host can edit/remove real fees)
- UAT Test 8 (Backward Compatibility) passes on re-test
</success_criteria>

<output>
After completion, create `.planning/phases/21-multiple-fees-taxes/21-03-SUMMARY.md`
</output>
