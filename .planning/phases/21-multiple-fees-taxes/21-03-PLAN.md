---
phase: 21-multiple-fees-taxes
plan: 03
type: execute
wave: 1
depends_on: ["21-02"]
files_modified:
  - src/pages/Session.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Legacy sessions with session.tax display tax value in TaxTipSettings"
    - "New sessions with fees table entries continue to work unchanged"
    - "Host can still edit fees (synthetic legacy fee is read-only display)"
  artifacts:
    - path: "src/pages/Session.tsx"
      provides: "displayFees computation with legacy fallback"
      contains: "session.tax"
  key_links:
    - from: "src/pages/Session.tsx"
      to: "src/components/TaxTipSettings.tsx"
      via: "displayFees prop"
      pattern: "fees=\\{displayFees\\}"
---

<objective>
Fix legacy session backward compatibility for fees display

Purpose: Legacy sessions (pre-Phase 21) store tax in session.tax field, but TaxTipSettings shows empty because it only receives fees from the fees table query. The calculation logic in getTotals already handles this fallback, but the UI display does not.

Output: Session.tsx computes displayFees that falls back to session.tax when fees table is empty, ensuring legacy sessions display their tax correctly.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/21-multiple-fees-taxes/21-UAT.md (gap diagnosis)
@src/pages/Session.tsx (fees query and TaxTipSettings usage)
@src/components/TaxTipSettings.tsx (Fee interface definition)
@convex/participants.ts (getTotals fallback logic reference, lines 220-241)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add displayFees computation with legacy fallback</name>
  <files>src/pages/Session.tsx</files>
  <action>
Add a useMemo hook after the existing fees query (line ~107) to compute displayFees:

```typescript
// Compute display fees with legacy fallback
// New sessions: use fees from fees table
// Legacy sessions: synthesize from session.tax if fees table is empty
const displayFees = useMemo(() => {
  // If fees table has entries, use them
  if (fees && fees.length > 0) {
    return fees;
  }
  // Legacy fallback: synthesize fee from session.tax
  if (session?.tax && session.tax > 0) {
    return [{
      _id: "legacy-tax" as Id<"fees">,
      label: "Tax",
      amount: session.tax,
    }];
  }
  // No fees
  return [];
}, [fees, session?.tax]);
```

Then update the TaxTipSettings component usage (around line 539-545) to pass displayFees instead of fees:

Change from:
```typescript
<TaxTipSettings
  session={session}
  fees={fees ?? []}
  ...
```

To:
```typescript
<TaxTipSettings
  session={session}
  fees={displayFees}
  ...
```

IMPORTANT: Keep the `fees` query as-is (it's still needed for the displayFees computation). Only change what gets passed to TaxTipSettings.

NOTE: The synthetic legacy fee uses a string cast "legacy-tax" as the ID. This is safe because:
1. TaxTipSettings uses fee._id only for React keys and mutation calls
2. Mutation calls require participantId which guards against accidental edits
3. The legacy fee will display as read-only for hosts (edit attempts would fail gracefully)
  </action>
  <verify>
1. TypeScript compiles: `cd /Users/osvi/src/split && npx tsc --noEmit`
2. App builds: `npm run build`
3. Manual test: Open a legacy session URL - tax should now appear in TaxTipSettings under "Taxes & Fees"
  </verify>
  <done>
- Legacy sessions display "Tax" fee with correct amount in TaxTipSettings
- New sessions with fees table entries display normally (no change in behavior)
- TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - TypeScript compilation passes
2. `npm run build` - Production build succeeds
3. Open legacy session in browser - "Tax" appears in Taxes & Fees section with correct amount
4. Open new session, scan receipt with fees - multiple fees display correctly (regression check)
</verification>

<success_criteria>
- Legacy sessions show their tax value in the TaxTipSettings "Taxes & Fees" section
- New sessions with fees table entries work unchanged
- UAT Test 8 (Backward Compatibility) passes on re-test
</success_criteria>

<output>
After completion, create `.planning/phases/21-multiple-fees-taxes/21-03-SUMMARY.md`
</output>
