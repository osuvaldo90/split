---
phase: 12-security-hardening
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [convex/sessions.ts, convex/participants.ts, convex/items.ts]
autonomous: true
---

<objective>
Add input validation bounds to prevent DoS and manipulation attacks.

Purpose: Prevent maliciously large strings, negative numbers, and out-of-bounds values from being stored.
Output: Convex validators with length limits and numeric bounds on all user inputs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-security-review/SECURITY-AUDIT.md

@convex/sessions.ts
@convex/participants.ts
@convex/items.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add validation helper functions</name>
  <files>convex/validation.ts</files>
  <action>
Create a new validation.ts file with helper functions for common validation patterns.

Contents:
```typescript
// convex/validation.ts
// Input validation helpers for security

// Max lengths for string inputs
export const MAX_NAME_LENGTH = 100;
export const MAX_ITEM_NAME_LENGTH = 200;

// Max value for money (in cents) - $100,000.00
export const MAX_MONEY_CENTS = 10_000_000;

// Max quantity for items
export const MAX_QUANTITY = 999;

// Validation functions that throw on invalid input
export function validateName(name: string, fieldName: string = "Name"): string {
  const trimmed = name.trim();
  if (trimmed.length === 0) {
    throw new Error(`${fieldName} cannot be empty`);
  }
  if (trimmed.length > MAX_NAME_LENGTH) {
    throw new Error(`${fieldName} cannot exceed ${MAX_NAME_LENGTH} characters`);
  }
  return trimmed;
}

export function validateItemName(name: string): string {
  const trimmed = name.trim();
  if (trimmed.length === 0) {
    throw new Error("Item name cannot be empty");
  }
  if (trimmed.length > MAX_ITEM_NAME_LENGTH) {
    throw new Error(`Item name cannot exceed ${MAX_ITEM_NAME_LENGTH} characters`);
  }
  return trimmed;
}

export function validateMoney(cents: number, fieldName: string = "Amount"): number {
  if (!Number.isFinite(cents)) {
    throw new Error(`${fieldName} must be a valid number`);
  }
  if (cents < 0) {
    throw new Error(`${fieldName} cannot be negative`);
  }
  if (cents > MAX_MONEY_CENTS) {
    throw new Error(`${fieldName} cannot exceed $100,000`);
  }
  if (!Number.isInteger(cents)) {
    throw new Error(`${fieldName} must be a whole number (cents)`);
  }
  return cents;
}

export function validateQuantity(quantity: number): number {
  if (!Number.isFinite(quantity)) {
    throw new Error("Quantity must be a valid number");
  }
  if (quantity < 1) {
    throw new Error("Quantity must be at least 1");
  }
  if (quantity > MAX_QUANTITY) {
    throw new Error(`Quantity cannot exceed ${MAX_QUANTITY}`);
  }
  if (!Number.isInteger(quantity)) {
    throw new Error("Quantity must be a whole number");
  }
  return quantity;
}

export function validateTipPercent(percent: number): number {
  if (!Number.isFinite(percent)) {
    throw new Error("Tip percent must be a valid number");
  }
  if (percent < 0) {
    throw new Error("Tip percent cannot be negative");
  }
  if (percent > 100) {
    throw new Error("Tip percent cannot exceed 100%");
  }
  return percent;
}
```
  </action>
  <verify>File created and TypeScript compiles: `npx convex dev --once`</verify>
  <done>Validation helpers created with clear error messages</done>
</task>

<task type="auto">
  <name>Task 2: Apply validation to sessions.ts and participants.ts</name>
  <files>convex/sessions.ts, convex/participants.ts</files>
  <action>
Import and apply validation functions to all mutations.

In sessions.ts:
- `create`: Use `validateName(args.hostName, "Host name")`
- `updateTip`: Use `validateTipPercent(args.tipValue)` for percent types, `validateMoney(args.tipValue, "Tip amount")` for manual type
- `updateTax`: Use `validateMoney(args.tax, "Tax")`
- `updateTotals`: Use `validateMoney(args.subtotal, "Subtotal")`, `validateMoney(args.tax, "Tax")`
- `updateGratuity`: Use `validateMoney(args.gratuity, "Gratuity")`

In participants.ts:
- `join`: Use `validateName(args.name, "Name")`
- `updateName`: Use `validateName(args.name, "Name")`

Import at top of each file:
```typescript
import { validateName, validateMoney, validateTipPercent } from "./validation";
```
  </action>
  <verify>TypeScript compiles: `npx convex dev --once`</verify>
  <done>All session and participant mutations validate their inputs</done>
</task>

<task type="auto">
  <name>Task 3: Apply validation to items.ts</name>
  <files>convex/items.ts</files>
  <action>
Import and apply validation functions to all item mutations.

In items.ts:
- `add`:
  - Use `validateItemName(args.name)`
  - Use `validateMoney(args.price, "Price")`
  - If quantity provided: `validateQuantity(args.quantity)`

- `update`:
  - If name provided: `validateItemName(args.name)`
  - If price provided: `validateMoney(args.price, "Price")`
  - If quantity provided: `validateQuantity(args.quantity)`

- `addBulk`:
  - For each item in array:
    - `validateItemName(item.name)`
    - `validateMoney(item.price, "Price")`
    - If quantity provided: `validateQuantity(item.quantity)`
  - Also add max array length check: `if (args.items.length > 500) throw new Error("Too many items (max 500)")`

Import at top:
```typescript
import { validateItemName, validateMoney, validateQuantity } from "./validation";
```
  </action>
  <verify>TypeScript compiles: `npx convex dev --once`</verify>
  <done>All item mutations validate their inputs with clear error messages</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx convex dev --once` succeeds
- [ ] Manual test: Empty name rejected with clear error
- [ ] Manual test: Very long name (>100 chars) rejected
- [ ] Manual test: Negative price rejected
- [ ] Manual test: Extremely large price (>$100,000) rejected
- [ ] Manual test: Normal operations still work
- [ ] Manual test: Valid item with quantity saves correctly
</verification>

<success_criteria>

- New validation.ts file with reusable validators
- All name fields limited to 100-200 characters
- All money fields reject negative and extremely large values
- All quantity fields reject non-positive and extremely large values
- Tip percent capped at 100%
- Clear, user-friendly error messages
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-security-hardening/12-03-SUMMARY.md`
</output>
