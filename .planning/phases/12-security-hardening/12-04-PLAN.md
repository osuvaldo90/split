---
phase: 12-security-hardening
plan: 04
type: execute
wave: 1
depends_on: []
files_modified: [convex/receipts.ts]
autonomous: true
---

<objective>
Add session verification to receipt URL query to prevent cross-session image access.

Purpose: Ensure receipt images can only be accessed by users who know both the sessionId and storageId.
Output: Secured `getReceiptUrl` query that verifies storageId belongs to the session.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-security-review/SECURITY-AUDIT.md

@convex/receipts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sessionId verification to getReceiptUrl</name>
  <files>convex/receipts.ts</files>
  <action>
Modify the `getReceiptUrl` query to require sessionId and verify the storageId matches.

Change from:
```typescript
export const getReceiptUrl = query({
  args: { storageId: v.id("_storage") },
  handler: async (ctx, args) => {
    return await ctx.storage.getUrl(args.storageId);
  },
});
```

Change to:
```typescript
export const getReceiptUrl = query({
  args: {
    sessionId: v.id("sessions"),
    storageId: v.id("_storage"),
  },
  handler: async (ctx, args) => {
    // Verify the storageId belongs to this session
    const session = await ctx.db.get(args.sessionId);
    if (!session) {
      throw new Error("Session not found");
    }
    if (session.receiptImageId !== args.storageId) {
      throw new Error("Receipt image not found for this session");
    }
    return await ctx.storage.getUrl(args.storageId);
  },
});
```

This ensures:
1. The session exists
2. The requested storageId is actually the session's receipt image
3. Users can't access arbitrary storage IDs
  </action>
  <verify>TypeScript compiles: `npx convex dev --once`</verify>
  <done>getReceiptUrl verifies storageId belongs to the requested session</done>
</task>

<task type="auto">
  <name>Task 2: Update frontend calls to pass sessionId</name>
  <files>src/components/ReceiptModal.tsx, src/pages/Bill.tsx</files>
  <action>
Update frontend components that call getReceiptUrl to pass sessionId.

Search for usages:
- `useQuery(api.receipts.getReceiptUrl`

For each usage:
- Add sessionId parameter
- Get sessionId from context (should be available on Bill page)

The ReceiptModal component likely receives sessionId as a prop or from context. Update the query call:
```typescript
// Before
const receiptUrl = useQuery(api.receipts.getReceiptUrl,
  receiptImageId ? { storageId: receiptImageId } : "skip"
);

// After
const receiptUrl = useQuery(api.receipts.getReceiptUrl,
  receiptImageId ? { sessionId, storageId: receiptImageId } : "skip"
);
```

If sessionId is not available in the component, thread it through from the Bill page where the session data is loaded.
  </action>
  <verify>Run `npm run build` to verify no TypeScript errors</verify>
  <done>All frontend calls to getReceiptUrl include sessionId parameter</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx convex dev --once` succeeds
- [ ] `npm run build` succeeds
- [ ] Manual test: Receipt image modal loads correctly for session host
- [ ] Manual test: Receipt image modal loads correctly for participants
- [ ] Manual test: Direct API call with wrong sessionId rejected
- [ ] Manual test: Direct API call with non-existent storageId rejected
</verification>

<success_criteria>

- getReceiptUrl requires sessionId parameter
- Query verifies storageId matches session's receiptImageId
- Frontend passes sessionId correctly
- Receipt viewing still works for all session participants
- Cross-session access prevented
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-security-hardening/12-04-SUMMARY.md`
</output>
