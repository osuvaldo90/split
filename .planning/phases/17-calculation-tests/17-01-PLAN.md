---
phase: 17-calculation-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [convex/calculations.test.ts]
autonomous: true

must_haves:
  truths:
    - "Even split tests verify remainder goes to first claimants"
    - "Tax distribution tests verify proportional calculation"
    - "All tip modes tested (percent_subtotal, percent_total, manual)"
    - "Edge cases handled (zero claimants, single claimant, zero amounts)"
  artifacts:
    - path: "convex/calculations.test.ts"
      provides: "Complete test suite for calculation functions"
      min_lines: 200
      contains: "BTEST-10"
  key_links:
    - from: "convex/calculations.test.ts"
      to: "convex/calculations.ts"
      via: "import { calculateItemShare, calculateTaxShare, calculateTipShare, distributeWithRemainder }"
      pattern: "import.*from.*calculations"
---

<objective>
Create comprehensive unit tests for all financial calculation functions in calculations.ts.

Purpose: Cover all BTEST-10 through BTEST-15 requirements ensuring calculation correctness for bill splitting, tax distribution, and tip calculation with all edge cases.

Output: convex/calculations.test.ts with tests covering even splits with remainders, proportional tax/tip distribution, and edge cases.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-authorization-tests/16-01-SUMMARY.md

# Source files to test:
@convex/calculations.ts

# Test patterns established:
@convex/sessions.test.ts - for test structure reference
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create item share and distribution tests (BTEST-10, BTEST-15)</name>
  <files>convex/calculations.test.ts</files>
  <action>
Create convex/calculations.test.ts with tests for:

**calculateItemShare tests (BTEST-10):**
- Even division: $10 (1000 cents) ÷ 2 = [500, 500]
- With remainder: $10 (1000 cents) ÷ 3 = [334, 333, 333] (first gets extra)
- Large remainder: 5 cents ÷ 3 = [2, 2, 1]
- Single claimant: 1000 ÷ 1 = [1000]

**distributeWithRemainder tests (BTEST-10):**
- Equal proportions: [100, 100] with 201 total → [101, 100]
- Unequal proportions: [60, 40] with 100 total → [60, 40]
- Zero proportions fallback to equal: [0, 0, 0] with 99 total → [33, 33, 33]
- Remainder goes to largest fractional parts

**Edge cases (BTEST-15):**
- Zero claimants: calculateItemShare(1000, 0) = []
- Zero amount: calculateItemShare(0, 3) = [0, 0, 0]
- Single claimant: calculateItemShare(1000, 1) = [1000]
- Empty proportions: distributeWithRemainder(100, []) = []

Import directly from calculations.ts (pure functions, no convex-test needed).
Use describe blocks for each function. Reference BTEST requirements in test names.
  </action>
  <verify>npm test -- --reporter=verbose 2>&1 | grep -E "(PASS|FAIL|✓|×)" | head -30</verify>
  <done>All calculateItemShare and distributeWithRemainder tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Create tax share tests (BTEST-11)</name>
  <files>convex/calculations.test.ts</files>
  <action>
Add tests for calculateTaxShare and calculateSubtotalShare:

**calculateSubtotalShare tests:**
- Half share: 500 / 1000 = 0.5
- Third share: 333 / 1000 ≈ 0.333
- Full share: 1000 / 1000 = 1.0
- Zero subtotal: any / 0 = 0 (edge case)
- Zero participant: 0 / 1000 = 0

**calculateTaxShare tests (BTEST-11):**
- Proportional: participant has 50% of subtotal → 50% of tax
- Rounding: 100 tax with 33.3% share → 33 cents (Math.round)
- Full tax to single: 100% share → 100% of tax
- Zero group subtotal: returns 0
- Zero participant subtotal: returns 0 tax share

Use descriptive test names: "should distribute tax proportionally to subtotal share (BTEST-11)"
  </action>
  <verify>npm test -- --reporter=verbose 2>&1 | grep -E "calculateTaxShare|calculateSubtotalShare" | head -20</verify>
  <done>All tax distribution tests pass verifying proportional calculation</done>
</task>

<task type="auto">
  <name>Task 3: Create tip calculation tests (BTEST-12, BTEST-13, BTEST-14)</name>
  <files>convex/calculations.test.ts</files>
  <action>
Add tests for calculateTipShare covering all tip modes:

**percent_subtotal mode (BTEST-12):**
- 20% tip on $50 subtotal = $10 (1000 cents)
- 15% tip on $33.33 subtotal = $5 (500 cents, rounded)
- 0% tip = 0
- Edge: 0 subtotal = 0 tip

**percent_total mode (BTEST-13):**
- 20% tip on ($50 subtotal + $5 tax) = $11 (1100 cents)
- Includes tax in calculation
- 0% tip = 0
- Edge: 0 subtotal + 0 tax = 0

**manual mode (BTEST-14):**
- $20 tip distributed proportionally by subtotal
- Participant with 50% subtotal share gets 50% of tip
- Edge: 0 group subtotal → 0 tip share
- Remainder distribution: verify sum equals total

**calculateParticipantTotal tests:**
- Simple addition: 500 + 50 + 100 = 650
- Zero values: 500 + 0 + 0 = 500

Ensure each BTEST requirement is explicitly named in at least one test.
  </action>
  <verify>npm test -- --reporter=verbose 2>&1 | grep -E "BTEST-1[234]" | head -20</verify>
  <done>All tip calculation tests pass for all three modes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test` passes all calculation tests
- [ ] All 6 BTEST requirements (10-15) have explicit tests
- [ ] Tests cover edge cases: zero claimants, zero amounts, single claimant
- [ ] Tests verify remainder handling distributes extra cents correctly
- [ ] No TypeScript errors
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Tests explicitly reference BTEST-10 through BTEST-15
- Edge cases tested (zero claimants, single claimant)
- Remainder distribution verified (penny goes to first/largest fractional)
</success_criteria>

<output>
After completion, create `.planning/phases/17-calculation-tests/17-01-SUMMARY.md`
</output>
