---
phase: 20-image-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/actions/parseReceipt.ts
  - src/pages/Session.tsx
autonomous: true

must_haves:
  truths:
    - "User uploading a non-receipt image sees an error message"
    - "User can retry with a different image after error"
    - "Valid receipt images continue to process normally"
  artifacts:
    - path: "convex/actions/parseReceipt.ts"
      provides: "Receipt validation and extraction with structured outputs"
      contains: "is_receipt"
    - path: "src/pages/Session.tsx"
      provides: "User-friendly error messages for rejection reasons"
      contains: "rejection_reason"
  key_links:
    - from: "convex/actions/parseReceipt.ts"
      to: "anthropic.beta.messages.create"
      via: "structured outputs beta"
      pattern: "betas.*structured-outputs"
    - from: "src/pages/Session.tsx"
      to: "parseReceipt result"
      via: "rejection_reason mapping"
      pattern: "rejection_reason"
---

<objective>
Add image validation to receipt OCR to detect non-receipt images and return user-friendly error messages.

Purpose: Users uploading random photos (landscapes, screenshots, documents) should see helpful feedback instead of cryptic parse errors, with guidance on how to fix the issue.

Output: Modified parseReceipt action with validation, updated Session UI with rejection reason messages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-image-validation/20-RESEARCH.md

@convex/actions/parseReceipt.ts
@src/pages/Session.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add validation to parseReceipt with structured outputs</name>
  <files>convex/actions/parseReceipt.ts</files>
  <action>
Modify the parseReceipt action to use structured outputs and detect non-receipts:

1. **Update the prompt** to include validation logic:
   - Ask Claude to first determine if the image is a receipt
   - If yes: extract merchant, items, subtotal, tax, gratuity, total
   - If no: return rejection_reason and description

2. **Define JSON schema** for structured outputs (discriminated union):
   ```typescript
   // Receipt detected
   { is_receipt: true, confidence: number, data: { merchant, items, subtotal, tax, gratuity, total } }
   // Not a receipt
   { is_receipt: false, confidence: number, rejection_reason: "landscape_photo"|"screenshot"|"document"|"blurry"|"other", description: string }
   ```

3. **Update API call** to use structured outputs beta:
   - Change `anthropic.messages.create()` to `anthropic.beta.messages.create()`
   - Add `betas: ["structured-outputs-2025-11-13"]`
   - Add `output_format: { type: "json_schema", schema: receiptValidationSchema }`

4. **Update ParsedReceipt type** to include validation errors:
   - Add `rejection_reason` and `description` fields to the error variant
   - Keep existing error format for backwards compatibility with other parse failures

5. **Add confidence threshold check** (0.7):
   - If is_receipt is false OR confidence < 0.7, return validation error
   - Include rejection_reason in the error response

6. **Remove manual JSON parsing**:
   - Structured outputs guarantees valid JSON
   - Remove the markdown code fence stripping logic
   - Remove try/catch around JSON.parse (or simplify to direct parse)

Key prompt additions:
```
First, determine if this image is a receipt (a purchase record from a store/restaurant).

If it IS a receipt (is_receipt: true):
- Extract merchant, items, subtotal, tax, gratuity, total
- Provide confidence (0.0-1.0) that this is a valid receipt

If it is NOT a receipt (is_receipt: false):
- Classify why: landscape_photo, screenshot, document, blurry, other
- Briefly describe what the image appears to be
- Provide confidence (0.0-1.0) that this is NOT a receipt
```
  </action>
  <verify>
Run `npx convex dev` and check that the action compiles without type errors.
Test manually by uploading a non-receipt image (e.g., screenshot) and verify the response includes rejection_reason.
  </verify>
  <done>
parseReceipt returns discriminated union with is_receipt boolean, uses structured outputs beta, and includes rejection_reason for non-receipts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Map rejection reasons to user-friendly error messages</name>
  <files>src/pages/Session.tsx</files>
  <action>
Update the error handling in Session.tsx to display helpful messages based on rejection_reason:

1. **Add rejection message mapping** at file top (after imports):
   ```typescript
   const REJECTION_MESSAGES: Record<string, { title: string; hint: string }> = {
     landscape_photo: {
       title: "This doesn't look like a receipt",
       hint: "Try taking a photo of your receipt instead"
     },
     screenshot: {
       title: "Screenshots aren't supported",
       hint: "Please take a photo of the physical receipt"
     },
     document: {
       title: "This looks like a document, not a receipt",
       hint: "Make sure you're photographing a store receipt"
     },
     blurry: {
       title: "The image is too blurry",
       hint: "Try taking another photo with better lighting"
     },
     other: {
       title: "We couldn't recognize this as a receipt",
       hint: "Try taking a clearer photo of your receipt"
     }
   };
   ```

2. **Update handleReceiptUpload** error handling (around line 150):
   - Check for `rejection_reason` in the result (new validation error format)
   - If present, use REJECTION_MESSAGES to build a user-friendly message
   - Format: `{title}\n\n{hint}`
   - Keep existing error handling for other error types (parse_failed, etc.)

   ```typescript
   if ("error" in result) {
     // Check for validation rejection (non-receipt)
     if ("rejection_reason" in result && result.rejection_reason) {
       const msg = REJECTION_MESSAGES[result.rejection_reason] || REJECTION_MESSAGES.other;
       setReceiptState({
         step: "error",
         message: `${msg.title}\n\n${msg.hint}`,
       });
       return;
     }
     // Existing parse error handling
     const rawPreview = result.raw ? `\n\nRaw response: ${result.raw.slice(0, 500)}` : "";
     setReceiptState({
       step: "error",
       message: `OCR failed: ${result.error}.${rawPreview}`,
     });
     return;
   }
   ```

3. **Update error display** (line 404-405):
   - The current display shows `receiptState.message` directly
   - For multi-line messages, split on `\n\n` and render separately
   - Title in red-600 font-medium, hint in gray-600 text-sm

   Update the error state JSX:
   ```tsx
   {receiptState.step === "error" && (
     <div className="text-center py-6">
       {/* existing icon */}
       {receiptState.message.includes("\n\n") ? (
         <>
           <p className="text-red-600 font-medium">
             {receiptState.message.split("\n\n")[0]}
           </p>
           <p className="text-sm text-gray-600 mt-1">
             {receiptState.message.split("\n\n")[1]}
           </p>
         </>
       ) : (
         <>
           <p className="text-red-600 font-medium">Something went wrong</p>
           <p className="text-sm text-gray-600 mt-1">{receiptState.message}</p>
         </>
       )}
       {/* existing Try Again button */}
     </div>
   )}
   ```
  </action>
  <verify>
Run `npm run dev` and verify the app compiles.
Test by uploading a non-receipt image and confirm:
- Error message shows user-friendly title
- Hint text appears below
- "Try Again" button still works
  </verify>
  <done>
Non-receipt uploads show user-friendly error messages with recovery hints. Retry flow continues to work.
  </done>
</task>

</tasks>

<verification>
1. **Non-receipt detection:** Upload a landscape photo or screenshot - should see rejection message
2. **User-friendly message:** Error shows title + hint, not cryptic parse error
3. **Retry works:** Click "Try Again", upload valid receipt - should process normally
4. **Valid receipts:** Upload actual receipt image - should extract items as before
5. **Structured outputs:** Check Convex logs - API call uses beta endpoint, returns valid JSON
</verification>

<success_criteria>
- User uploading non-receipt sees: "This doesn't look like a receipt" (or similar based on rejection_reason)
- User can tap "Try Again" and upload a different image
- Valid receipt images extract items correctly (no regression)
- No type errors in convex or react app
</success_criteria>

<output>
After completion, create `.planning/phases/20-image-validation/20-01-SUMMARY.md`
</output>
