# Milestone v1.3: Smart Receipt Scanning

**Status:** SHIPPED 2026-01-19
**Phases:** 20-22
**Total Plans:** 5

## Overview

v1.3 enhances receipt scanning to handle real-world complexity: multiple fees/taxes, handwritten tips on signed receipts, and invalid image detection. These 3 phases build on the existing Claude Vision OCR infrastructure.

## Phases

### Phase 20: Image Validation

**Goal**: Detect non-receipt images and allow retry
**Depends on**: Nothing (first v1.3 phase)
**Requirements**: OCR-03
**Plans**: 1 plan

Plans:
- [x] 20-01: Add validation to parseReceipt with structured outputs and user-friendly error messages

**Details:**
- Added receipt validation to parseReceipt action with is_receipt boolean and confidence score
- Integrated structured outputs beta for guaranteed valid JSON responses
- Created user-friendly error messages mapping for 5 rejection reasons
- Updated Session.tsx error display with title + hint formatting

**Key Decisions:**
- Combined validation + extraction in single API call to avoid double latency and cost
- Set confidence threshold at 0.7 based on research recommendations
- Used five rejection reasons that map to actionable user guidance (landscape_photo, screenshot, document, blurry, other)

### Phase 21: Multiple Fees/Taxes

**Goal**: Extract and classify multiple fees/taxes from receipts
**Depends on**: Phase 20
**Requirements**: OCR-02
**Plans**: 3 plans

Plans:
- [x] 21-01: Add fees table and CRUD operations, update calculation engine
- [x] 21-02: Update OCR to extract multiple fees, update UI for fees section
- [x] 21-03: Fix legacy session backward compatibility for fees display (gap closure)

**Details:**
- Added fees table to Convex schema with sessionId index
- Created fees.ts with full CRUD operations with host-only authorization
- Updated getTotals to distribute multiple fees proportionally
- Implemented dual-read fallback: reads from fees table first, falls back to session.tax
- Updated parseReceipt prompt and schema to extract multiple fees with exact labels
- Rewrote TaxTipSettings to display/edit fee list with add, remove, and inline editing
- Updated Summary breakdown to show "Taxes & Fees" label
- Legacy sessions show tax value as read-only synthetic fee

**Key Decisions:**
- Keep field names for backward compatibility (participant.tax retained)
- Return fees array in getTotals for UI display
- Max 50 fees per session in addBulk to prevent abuse
- Extract gratuity in both fees array AND gratuity field for special handling
- Use 'legacy-' prefix for synthetic fee IDs

### Phase 22: Handwritten Tip Detection

**Goal**: Detect handwritten tip amounts and pre-fill tip field
**Depends on**: Phase 20
**Requirements**: OCR-01
**Plans**: 1 plan

Plans:
- [x] 22-01: Extend parseReceipt for handwritten tip detection and add pre-fill logic

**Details:**
- Extended parseReceipt Claude Vision prompt to detect handwritten tips on signed receipts
- Added handwritten_tip schema to structured outputs (detected, amount, confidence, raw_text)
- Implemented automatic tip pre-fill in Session.tsx when confidence >= 0.8
- Silent behavior - no UI feedback per user requirements

**Key Decisions:**
- 0.8 confidence threshold (higher than receipt validation because handwriting is harder)
- Silent pre-fill behavior - no toast or indicator
- Use tipType 'manual' for pre-filled amounts (dollars to cents conversion)

---

## Milestone Summary

**Decimal Phases:**
None in this milestone.

**Key Decisions:**
- Decision: Structured outputs beta for guaranteed JSON (Rationale: Eliminate parsing errors)
- Decision: 0.7 confidence threshold for receipt validation (Rationale: Balance acceptance vs rejection)
- Decision: 0.8 confidence threshold for handwritten tips (Rationale: Higher threshold for handwriting)
- Decision: Dual-read fallback for fees migration (Rationale: Backward compatibility for existing sessions)
- Decision: Extract gratuity in fees AND gratuity field (Rationale: Special distribution logic needs both)

**Issues Resolved:**
- Non-receipt images now show helpful messages with retry guidance
- Multiple fees/taxes now properly extracted and distributed
- Handwritten tips automatically detected and pre-filled
- Legacy sessions work with new fees feature via synthetic fee display

**Issues Deferred:**
- AI disclaimer after OCR scan (OCR-04) moved to backlog

**Technical Debt Incurred:**
- Confidence thresholds (0.7, 0.8) may need tuning based on production data

---

_For current project status, see .planning/ROADMAP.md_
